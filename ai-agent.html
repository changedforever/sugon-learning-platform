<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能体 - 曙光学习平台</title>
    <link rel="stylesheet" href="css/tailwind.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f5f7fb;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .sidebar {
            width: 260px;
            background: #f8fafd;
            border-right: 1px solid #eaecef;
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: all 0.3s ease;
            /* 确保下拉菜单不被裁剪 */
            overflow: visible;
        }
        
        .sidebar-header {
            padding: 12px 0;
            border-bottom: 1px solid #eaecef;
            margin-bottom: 16px;
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #eaecef;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sidebar-btn:hover {
            background: #f0f4ff;
            border-color: #b0c4ff;
        }
        
        .sidebar-btn.active {
            background: #e6eeff;
            border-color: #4a86ff;
            color: #1a56db;
        }
        
        .sidebar-btn-expandable {
            justify-content: space-between;
        }
        
        .sidebar-btn-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-btn-arrow {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        /* 移除箭头旋转效果，由JavaScript控制图标切换 */
        /* .sidebar-btn-expandable.expanded .sidebar-btn-arrow {
            transform: rotate(180deg);
        } */
        
        .sidebar-submenu {
            margin-left: 16px;
            margin-top: 4px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .sidebar-submenu-item {
            padding: 10px 12px;
            border-radius: 6px;
            background: #f8fafd;
            border: 1px solid #eaecef;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* 确保下拉菜单不被裁剪 */
            overflow: visible;
        }

        .sidebar-submenu-item-content {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-submenu-item-actions {
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sidebar-submenu-item:hover .sidebar-submenu-item-actions {
            opacity: 1;
        }

        .more-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .more-btn:hover {
            background: #e6eeff;
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 4px;
            background: white;
            border: 1px solid #eaecef;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            min-width: 120px;
            display: none;
            /* 确保下拉菜单可见 */
            opacity: 1;
            visibility: visible;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background: #f0f4ff;
        }

        .dropdown-item i {
            margin-right: 8px;
            font-size: 12px;
        }
        
        .sidebar-submenu-item:hover {
            background: #e6eeff;
            border-color: #b0c4ff;
        }
        
        .sidebar-submenu-item.active {
            background: #e6eeff;
            border-color: #4a86ff;
            color: #1a56db;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8fafd;
            min-height: 0;
        }
        
        /* 面板通用容器：占满剩余高度，允许内部滚动 */
        .panel-section {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* 对话面板：强制使用 flex 计算的高度，防止被内容撑开 */
        #panel-chat {
            height: 0; /* 配合 flex: 1 使用，强制使用 flex 计算的高度 */
        }
        
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #eaecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            flex-shrink: 0;
        }
        
        .chat-title-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .chat-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .chat-subtitle {
            font-size: 13px;
            color: #666;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .messages-container {
            flex: 1;
            min-height: 0;
            height: 0; /* 配合 flex: 1 使用，强制使用 flex 计算的高度，防止被内容撑开 */
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            order: 1;
            /* 优化滚动条样式 */
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f1f5f9;
        }
        
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .message {
            display: flex;
            gap: 16px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
        }
        
        .avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a86ff, #667eea);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .bot-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .message-content {
            padding: 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .user-message .message-content {
            background: linear-gradient(135deg, #4a86ff, #667eea);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message .message-content {
            background: white;
            border: 1px solid #eaecef;
            border-bottom-left-radius: 4px;
        }
        
        .quick-questions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .quick-questions-left {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex: 1;
        }
        
        .quick-question {
            padding: 8px 16px;
            background: #f0f4ff;
            border: 1px solid #d0ddf7;
            border-radius: 20px;
            font-size: 13px;
            color: #4a86ff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-question:hover {
            background: #e6eeff;
            border-color: #b0c4ff;
        }
        
        .input-area {
            padding: 12px 20px 18px;
            /* border-top: 1px solid #eaecef; */
            /* background: white; */
            margin-top: 0;
            flex-shrink: 0;
            background: white;
            order: 2;
            position: relative;
            z-index: 10;
        }

        /* 能力场景 + 猜你想问 卡片区域 */
        .ability-panels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 900px;          /* 略微加宽，容纳三列卡片 */
            margin: 40px auto 16px;    /* 在对话区中间偏上的位置居中 */
        }

        .ability-card {
            background: linear-gradient(135deg, #fff7f7, #fff9fb);
            border-radius: 18px;
            padding: 14px 16px 16px;
            box-shadow: 0 8px 18px rgba(255, 139, 154, 0.1);
            border: 1px solid rgba(255, 160, 180, 0.35);
        }

        .ability-card:nth-child(2) {
            background: linear-gradient(135deg, #fffaf3, #fff9f0);
            box-shadow: 0 8px 18px rgba(255, 179, 102, 0.12);
            border-color: rgba(255, 193, 120, 0.45);
        }

        .ability-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            color: #555;
        }

        .ability-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .ability-card-page {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #999;
        }

        .ability-card-page i {
            font-size: 11px;
        }

        .ability-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ability-item {
            text-align: left;
            padding: 10px 12px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .ability-item:hover {
            background: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 160, 180, 0.18);
        }

        .ability-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }

        .ability-item-subtitle {
            font-size: 12px;
            color: #999;
        }

        .guess-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .guess-question {
            padding: 6px 10px;
            border-radius: 16px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .guess-question:hover {
            background: #ffffff;
            color: #333;
            box-shadow: 0 4px 10px rgba(255, 193, 120, 0.25);
            transform: translateY(-1px);
        }

        .guess-banner {
            margin-top: 6px;
            padding: 10px 12px;
            border-radius: 12px;
            background: linear-gradient(90deg, #fef0ff, #e3f0ff);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .guess-banner-content {
            flex: 1;
        }

        .guess-banner-title {
            font-size: 13px;
            font-weight: 600;
            color: #444;
            margin-bottom: 2px;
        }

        .guess-banner-subtitle {
            font-size: 11px;
            color: #888;
        }

        .guess-banner-action {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff8a4a;
            font-size: 13px;
        }

        /* 收起动画：回答问题时隐藏能力场景/猜你想问（以及可选的快捷提问） */
        .ability-panels,
        .quick-questions {
            transition: max-height 0.25s ease, opacity 0.2s ease, margin 0.25s ease;
            overflow: hidden;
        }

        .chat-container.panels-collapsed .ability-panels,
        .chat-container.panels-collapsed .quick-questions {
            max-height: 0 !important;
            opacity: 0;
            margin-bottom: 0 !important;
            pointer-events: none;
        }
        
        .input-container {
            position: relative;
            display: flex;
            flex-direction: column;
            background: white;
            border: 1px solid #eaecef;
            border-radius: 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-container:focus-within {
            border-color: #4a86ff;
            box-shadow: 0 0 0 2px rgba(74, 134, 255, 0.1);
        }

        .input-inner-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 12px;
        }
        
        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 0;
            font-size: 15px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            background: transparent;
        }
        
        .message-input:focus {
            border: none;
            box-shadow: none;
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #4a86ff, #667eea);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 134, 255, 0.3);
        }

        .send-btn:active {
            transform: translateY(0);
        }
        
        .resource-card {
            background: #f8fafd;
            border: 1px solid #eaecef;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .resource-item:last-child {
            margin-bottom: 0;
        }

        .resource-img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
        }

        .r-i-radio {
            width: 300px;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .resource-info {
            flex: 1;
        }
        
        .resource-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .resource-desc {
            font-size: 12px;
            color: #666;
        }
        
        .resource-btn {
            padding: 6px 12px;
            background: #4a86ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .welcome-icon {
            font-size: 48px;
            color: #a0aec0;
            margin-bottom: 16px;
        }
        
        .welcome-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .welcome-subtext {
            font-size: 14px;
            color: #718096;
        }

        /* 对话结束后的进阶问题推荐区域 */
        .followups-container {
            margin: 8px 0 4px 46px; /* 与头像/气泡对齐，略微缩进 */
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 80%;
            align-items: flex-start;
        }

        .followup-btn {
            border: none;
            outline: none;
            background: #f3f4f6;
            color: #4b5563;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease;
        }

        .followup-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(15, 23, 42, 0.12);
        }

        .followup-btn span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .followup-icon {
            font-size: 12px;
            color: #9ca3af;
        }

        /* 提示框样式 - 分割线 */
        .permission-help-box {
            margin: 12px 0 8px 46px;
            max-width: 80%;
            padding: 14px 16px 14px 0;
            border-top: 1px solid #eaecef;
        }

        .permission-help-text {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            font-weight: 500;
        }

        /* 技能选择器样式（下载 + 二级标签） - 默认隐藏，根据需要再启用 */
        .skill-selector {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px 6px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border-bottom: 1px solid #f0f0f0;
        }

        .skill-selector::-webkit-scrollbar {
            display: none;
        }

        /* 一级：下载 按钮 */
        .skill-main {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 18px;
            background: #f5f5f7;
            border: 1px solid #e0e0e0;
            color: #555;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
        }

        .skill-main-label {
            padding: 0 2px;
        }

        .skill-main-close {
            font-size: 12px;
            color: #b0b0b0;
            margin-left: 2px;
            display: none; /* 默认不展示，展开后再显示 */ 
        }

        .skill-main.expanded {
            background: #f0f2ff;
            border-color: #d0d5ff;
            color: #333;
        }

        .skill-main.expanded .skill-main-close {
            color: #999;
            display: inline-block;
        }

        /* 二级：CPU / DCU / 云计算 标签 */
        .skill-sub-list {
            display: none;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
        }

        .skill-selector.expanded .skill-sub-list {
            display: inline-flex;
        }

        .skill-sub-item {
            padding: 4px 12px;
            border-radius: 14px;
            background: #f7f7f8;
            border: 1px solid transparent;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.16s ease;
        }

        .skill-sub-item:hover {
            background: #ffffff;
            border-color: #e0e0e0;
        }

        .skill-sub-item.active {
            background: #ffffff;
            border-color: #d0d5ff;
            color: #333;
            box-shadow: 0 0 0 1px rgba(115, 130, 255, 0.35);
        }

        /* 场景领域标签选中样式 */
        .scene-domain-item.active {
            background: #ffffff;
            border: 1px solid #d0d5ff;
            color: #333;
            box-shadow: 0 0 0 1px rgba(115, 130, 255, 0.35);
        }

        /* 已选领域提示为独立标签样式 */
        .selected-scene-domain {
            margin: 4px 12px 0;
            font-size: 12px;
            display: none;
        }

        .selected-scene-domain-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            border: 1px solid #c7d2fe;
        }

        .selected-scene-domain-text {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selected-scene-domain-close {
            cursor: pointer;
            font-size: 11px;
            color: #9ca3af;
            padding-left: 2px;
        }

        .selected-scene-domain-close:hover {
            color: #6b7280;
        }

        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #eaecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f0f4ff;
            color: #4a86ff;
        }

        /* 消息多选样式 */
        .message {
            position: relative;
        }

        .message-checkbox {
            position: absolute;
            top: 8px;
            left: -24px;
            width: 16px;
            height: 16px;
            border: 1px solid #eaecef;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: none;
            z-index: 10;
        }

        .message-checkbox.visible {
            display: block;
        }

        .message-checkbox.checked {
            background: #4a86ff;
            border-color: #4a86ff;
        }

        .message-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .message.selected {
            background: rgba(74, 134, 255, 0.05);
            border-radius: 12px;
            padding-left: 8px;
        }

        /* 底部操作按钮区域 */
        .action-buttons-area {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #eaecef;
            display: none;
            justify-content: space-between;
            align-items: center;
        }

        .action-buttons-area.visible {
            display: flex;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            padding: 10px 20px;
            border: 1px solid #eaecef;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: #f8fafd;
            border-color: #4a86ff;
            color: #4a86ff;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #4a86ff, #667eea);
            color: white;
            border-color: #4a86ff;
        }

        .action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 134, 255, 0.3);
        }

        .cancel-selection {
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .cancel-selection:hover {
            background: #f0f0f0;
        }

        /* 模式切換開關（问答 / 下载） */
        .mode-toggle-wrapper {
            flex-shrink: 0;
            margin-left: auto;
        }

        .mode-toggle-label {
            font-size: 12px;
            color: #888;
        }

        .mode-toggle {
            position: relative;
            width: 112px;
            height: 30px;
            border-radius: 999px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 2px;
            box-sizing: border-box;
            transition: background 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.03);
        }

        .mode-toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 54px;
            height: 24px;
            border-radius: 999px;
            background: #4a86ff;
            color: #fff;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.18s ease, background 0.18s ease, box-shadow 0.18s ease;
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.35);
        }

        .mode-toggle-text {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 12px;
            color: #9ca3af;
            user-select: none;
        }

        .mode-toggle.mode-download {
            background: #dbeafe;
            border-color: #93c5fd;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .mode-toggle.mode-download .mode-toggle-knob {
            transform: translateX(54px);
            background: #1d4ed8;
            box-shadow: 0 6px 12px rgba(30, 64, 175, 0.35);
        }

        .mode-toggle.mode-qa .mode-text-qa {
            color: #111827;
            font-weight: 600;
        }

        .mode-toggle.mode-download .mode-text-download {
            color: #1e40af;
            font-weight: 600;
        }

        /* 灯箱弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 500px;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eaecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-description {
            margin-bottom: 24px;
            color: #666;
            line-height: 1.5;
        }

        .rating-section {
            margin-bottom: 24px;
        }

        .rating-label {
            font-size: 14px;
            color: #333;
            margin-right: 12px;
        }

        .rating-stars {
            display: inline-flex;
            gap: 8px;
        }

        .rating-star {
            font-size: 24px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-star:hover,
        .rating-star.active {
            color: #ffc107;
        }

        .feedback-section {
            margin-bottom: 24px;
        }

        .feedback-label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
        }

        .feedback-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #eaecef;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .feedback-input:focus {
            outline: none;
            border-color: #4a86ff;
            box-shadow: 0 0 0 2px rgba(74, 134, 255, 0.1);
        }

        .modal-footer {
            padding: 16px 24px 24px;
            border-top: 1px solid #eaecef;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cancel-btn {
            background-color: white;
            border: 1px solid #eaecef;
            color: #666;
        }

        .cancel-btn:hover {
            background-color: #f8f9fa;
            border-color: #4a86ff;
            color: #4a86ff;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #4a86ff, #667eea);
            border: 1px solid #4a86ff;
            color: white;
        }

        .confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 134, 255, 0.3);
        }

        /* 线条操作按钮样式 */
        .inline-actions {
            margin-top: 4px;
            display: flex;
            gap: 16px;
        }

        .line-action-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .line-action-btn:hover {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .line-action-btn.liked {
            color: #4CAF50;
        }

        .line-action-btn.favorited {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <!-- 右键菜单 -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="context-menu-multiselect">多选</div>
    </div>

    <div class="chat-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i class="fas fa-robot"></i>
                    <span>AI 智能体</span>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="sidebar-btn active" data-target="chat">
                    <i class="fas fa-plus"></i>
                    <span>新对话</span>
                </button>
                <button class="sidebar-btn sidebar-btn-expandable" data-target="favorites">
                    <div class="sidebar-btn-content">
                    <i class="fas fa-star"></i>
                    <span>我的收藏</span>
                    </div>
                    <i class="fas fa-chevron-up sidebar-btn-arrow"></i>
                </button>
                <div class="sidebar-submenu" id="favorites-submenu" style="display: none;">
                    <!-- 二级菜单项将在这里动态生成 -->
                </div>
                <button class="sidebar-btn sidebar-btn-expandable expanded" data-target="history">
                    <div class="sidebar-btn-content">
                    <i class="fas fa-history"></i>
                    <span>历史对话</span>
                    </div>
                    <i class="fas fa-chevron-down sidebar-btn-arrow"></i>
                </button>
                <div class="sidebar-submenu" id="history-submenu" style="display: block;">
                    <div class="sidebar-submenu-item" data-id="1" data-type="history">
                        <div class="sidebar-submenu-item-content">如何配置DCU开发环境？</div>
                        <div class="sidebar-submenu-item-actions">
                            <div class="more-btn" data-id="1">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                            <div class="dropdown-menu" data-id="1">
                                <div class="dropdown-item favorite-item" data-id="1">
                                    <i class="fas fa-star"></i>
                                    <span>收藏</span>
                                </div>
                                <div class="dropdown-item rename-item" data-id="1">
                                    <i class="fas fa-edit"></i>
                                    <span>重命名</span>
                                </div>
                                <div class="dropdown-item delete-item" data-id="1">
                                    <i class="fas fa-trash"></i>
                                    <span>删除</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-submenu-item" data-id="2" data-type="history">
                        <div class="sidebar-submenu-item-content">CPU性能优化有哪些方法？</div>
                        <div class="sidebar-submenu-item-actions">
                            <div class="more-btn" data-id="2">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                            <div class="dropdown-menu" data-id="2">
                                <div class="dropdown-item favorite-item" data-id="2">
                                    <i class="fas fa-star"></i>
                                    <span>收藏</span>
                                </div>
                                <div class="dropdown-item rename-item" data-id="2">
                                    <i class="fas fa-edit"></i>
                                    <span>重命名</span>
                                </div>
                                <div class="dropdown-item delete-item" data-id="2">
                                    <i class="fas fa-trash"></i>
                                    <span>删除</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-submenu-item" data-id="3" data-type="history">
                        <div class="sidebar-submenu-item-content">云平台如何实现高可用？</div>
                        <div class="sidebar-submenu-item-actions">
                            <div class="more-btn" data-id="3">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                            <div class="dropdown-menu" data-id="3">
                                <div class="dropdown-item favorite-item" data-id="3">
                                    <i class="fas fa-star"></i>
                                    <span>收藏</span>
                                </div>
                                <div class="dropdown-item rename-item" data-id="3">
                                    <i class="fas fa-edit"></i>
                                    <span>重命名</span>
                                </div>
                                <div class="dropdown-item delete-item" data-id="3">
                                    <i class="fas fa-trash"></i>
                                    <span>删除</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-submenu-item" data-id="4" data-type="history">
                        <div class="sidebar-submenu-item-content">数据库索引优化策略</div>
                        <div class="sidebar-submenu-item-actions">
                            <div class="more-btn" data-id="4">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                            <div class="dropdown-menu" data-id="4">
                                <div class="dropdown-item favorite-item" data-id="4">
                                    <i class="fas fa-star"></i>
                                    <span>收藏</span>
                                </div>
                                <div class="dropdown-item rename-item" data-id="4">
                                    <i class="fas fa-edit"></i>
                                    <span>重命名</span>
                                </div>
                                <div class="dropdown-item delete-item" data-id="4">
                                    <i class="fas fa-trash"></i>
                                    <span>删除</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-submenu-item" data-id="5" data-type="history">
                        <div class="sidebar-submenu-item-content">操作系统进程调度算法</div>
                        <div class="sidebar-submenu-item-actions">
                            <div class="more-btn" data-id="5">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                            <div class="dropdown-menu" data-id="5">
                                <div class="dropdown-item favorite-item" data-id="5">
                                    <i class="fas fa-star"></i>
                                    <span>收藏</span>
                                </div>
                                <div class="dropdown-item rename-item" data-id="5">
                                    <i class="fas fa-edit"></i>
                                    <span>重命名</span>
                                </div>
                                <div class="dropdown-item delete-item" data-id="5">
                                    <i class="fas fa-trash"></i>
                                    <span>删除</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 头部 -->
            <div class="chat-header">
                <div class="chat-title-area">
                    <div class="avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <div class="chat-title">AI智能助手</div>
                        <div class="chat-subtitle" id="chat-subtitle-text">问你所惑，解你所需</div>
                    </div>
                </div>
                <div class="close-btn">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            
            <!-- 新对话主面板 -->
            <div id="panel-chat" class="panel-section">
                <!-- 消息区域 -->
                <div id="ai-messages" class="messages-container">
                    <div class="message bot-message">
                        <div class="avatar-small bot-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            您好！我是AI智能助手，展示认证流程，包括考试预约、获取与验证证书的入口，以及可能涉及的重认证规则。有什么可以帮助您的吗？
                        </div>
                    </div>

                    <!-- 能力场景 + 猜你想问（移动到中间内容区域） -->
                    <div class="ability-panels">
                        <!-- 右侧：下载相关（DCU / CPU） -->
                        <div class="ability-card">
                            <div class="ability-card-header">
                                <span class="ability-card-title">场景领域</span>
                            </div>
                            <div class="ability-list">
                                <button class="ability-item scene-domain-item" data-question="DCU 驱动下载">
                                    <div class="ability-item-title">DCU</div>
                                    <div class="ability-item-subtitle">获取最新 DCU 驱动与工具</div>
                                </button>
                                <button class="ability-item scene-domain-item" data-question="CPU 固件与驱动下载">
                                    <div class="ability-item-title">CPU</div>
                                    <div class="ability-item-subtitle">CPU 固件、驱动及文档资源</div>
                                </button>
                            </div>
                        </div>
                        <!-- 左侧：能力场景 -->
                        <div class="ability-card">
                            <div class="ability-card-header">
                                <span class="ability-card-title">服务器产品</span>
                                <div class="ability-card-page">
                                    <span>2/3</span>
                                    <i class="fas fa-angle-right"></i>
                                </div>
                            </div>
                            <div class="ability-list">
                                <button class="ability-item" data-question="服务器产品介绍">
                                    <div class="ability-item-title">产品介绍</div>
                                    <div class="ability-item-subtitle">了解服务器产品系列</div>
                                </button>
                                <button class="ability-item" data-question="服务器配置方案">
                                    <div class="ability-item-title">配置方案</div>
                                    <div class="ability-item-subtitle">根据需求推荐配置</div>
                                </button>
                                <button class="ability-item" data-question="服务器技术支持">
                                    <div class="ability-item-title">技术支持</div>
                                    <div class="ability-item-subtitle">获取服务器技术支持</div>
                                </button>
                            </div>
                        </div>

                        <!-- 中间：猜你想问 -->
                        <div class="ability-card">
                            <div class="ability-card-header">
                                <span class="ability-card-title">Q&A</span>
                            </div>
                            <div class="guess-questions">
                                <button class="guess-question" data-question="HCIE实验预约及考位查询">实验预约及考位查询</button>
                                <button class="guess-question" data-question="认证考试证书有效期">认证考试证书有效期</button>
                                <button class="guess-question" data-question="取消考试政策">取消考试政策</button>
                            </div>
                            <div class="guess-banner">
                                <div class="guess-banner-content">
                                    <div class="guess-banner-title">全新焕变</div>
                                    <div class="guess-banner-subtitle">能力升级 AI 问答更懂你</div>
                                </div>
                                <div class="guess-banner-action">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 输入区域 -->
                <div class="input-area" id="chat-input-area">
                    <!-- 原有快捷提问，仍然保留 -->
                    <div class="quick-questions" id="ai-quick-questions">
                        <div class="quick-questions-left">
                            <button class="quick-question">如何参加考试？</button>
                            <button class="quick-question">如何认证成为高级云架构师？</button>
                            <button class="quick-question">如何查看和下载证书</button>
                        </div>
                    </div>
                    <div class="input-container" style="position: relative; padding: 8px 8px 8px 6px;">
                        <!-- 场景领域提示标签（独立标签） -->
                        <div id="selected-scene-domain" class="selected-scene-domain">
                            <span class="selected-scene-domain-tag">
                                <span class="selected-scene-domain-text" id="selected-scene-domain-text"></span>
                                <span class="selected-scene-domain-close" id="selected-scene-domain-close">×</span>
                            </span>
                        </div>
                        <!-- 技能选择器 - 放在文本框内部上方 -->
                        <div class="skill-selector" id="skill-selector">
                            <div class="skill-main" id="download-main">
                                <span class="skill-main-label">下载</span>
                                <span class="skill-main-close" id="download-close">×</span>
                            </div>
                            <div class="skill-sub-list" id="download-sub-list">
                                <button class="skill-sub-item">CPU</button>
                                <button class="skill-sub-item">DCU</button>
                                <button class="skill-sub-item">云计算</button>
                            </div>
                        </div>
                        <!-- 输入框和发送按钮区域 -->
                        <div class="input-inner-wrapper" style="display: flex; gap: 8px; min-height: 80px; align-items: flex-start;">
                            <!-- 模式切换：问答 / 下载 - 放在输入框内部左下角 -->
                            <div class="mode-toggle-wrapper" style="position: absolute; bottom: 8px; left: 6px; z-index: 10;">
                                <div id="mode-toggle" class="mode-toggle mode-qa">
                                    <div class="mode-toggle-knob" id="mode-toggle-knob">问答</div>
                                    <div class="mode-toggle-text">
                                        <span class="mode-text-qa">问答</span>
                                        <span class="mode-text-download">下载</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 输入框容器，包含标签和输入区域 -->
                            <div style="flex: 1; display: flex; align-items: flex-start; gap: 8px; min-height: 60px;">
                                <!-- 模式标签显示 -->
                                <div class="input-mode-tag" id="input-mode-tag" style="background: #4a86ff; color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; z-index: 5;">问答</div>
                                <!-- 提示文案和输入区域 -->
                                <div style="flex: 1; position: relative;">
                                    <!-- 动态提示文案 -->
                                    <div id="input-placeholder" style="position: absolute; left: 0; top: 0; color: #9ca3af; font-size: 15px; pointer-events: none;">请输入您的问题...</div>
                                    <!-- 输入框 -->
                                    <textarea 
                                        id="ai-input" 
                                        class="message-input"
                                        rows="2"
                                        style="padding: 0; border: none; outline: none; background: transparent; width: 100%; min-height: 60px; max-height: 150px; resize: none; font-size: 15px;"
                                    ></textarea>
                                </div>
                            </div>
                            <button id="ai-send" class="send-btn" style="align-self: flex-start; margin-top: 4px;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <!-- 正式联想框样式 - 市面上常见的搜索联想 -->
                        <div id="suggestion-list" style="position: absolute; bottom: 100%; left: 0; right: 0; margin-bottom: 8px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 9999; display: none; overflow: hidden; width: 100%; border: 1px solid #eaecef;">
                            <div style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s;"><span style="color: red;">智能</span>天线</div>
                            <div style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s;">全网<span style="color: red;">智能</span></div>
                            <div style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; transition: all 0.2s;">体系智<span style="color: red;">能</span>特性</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 灯箱弹窗 -->
    <div id="evaluation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>评价光合小智</h3>
                <button class="modal-close-btn" id="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-description">邀请您对本次智能体的互动和体验进行评价</p>
                <div class="rating-section">
                    <span class="rating-label">互动和体验评分：</span>
                    <div class="rating-stars">
                        <i class="fas fa-star rating-star" data-rating="1"></i>
                        <i class="fas fa-star rating-star" data-rating="2"></i>
                        <i class="fas fa-star rating-star" data-rating="3"></i>
                        <i class="fas fa-star rating-star" data-rating="4"></i>
                        <i class="fas fa-star rating-star" data-rating="5"></i>
                    </div>
                </div>
                <div class="feedback-section">
                    <label for="feedback-input" class="feedback-label">评价内容：</label>
                    <textarea id="feedback-input" class="feedback-input" placeholder="请输入您的评价..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancel-btn">取消</button>
                <button class="modal-btn confirm-btn" id="confirm-btn">确定</button>
            </div>
        </div>
    </div>

    <script>
        // AI智能体功能
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM加载完成，开始初始化AI智能体功能');
        
        const aiInput = document.getElementById('ai-input');
        const aiSend = document.getElementById('ai-send');
        const aiMessages = document.getElementById('ai-messages');
        const inputArea = document.querySelector('.input-area');
        const chatContainer = document.querySelector('.chat-container');
        const abilityPanels = document.querySelector('.ability-panels');
        const suggestionList = document.getElementById('suggestion-list');
        const closeBtn = document.querySelector('.close-btn');
        const evaluationModal = document.getElementById('evaluation-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const ratingStars = document.querySelectorAll('.rating-star');
        let selectedRating = 0;

        // 收藏 & 历史对话 DOM
        const favoritesList = document.getElementById('favorites-list');
        const favoritesEmpty = document.getElementById('favorites-empty');
        const favoritesCount = document.getElementById('favorites-count');
        const historyList = document.getElementById('history-list');
        const historyEmpty = document.getElementById('history-empty');
        const historyCount = document.getElementById('history-count');

        // 侧边栏相关 DOM
        const sidebarButtons = document.querySelectorAll('.sidebar-btn');
        const panelChat = document.getElementById('panel-chat');
        const chatInputArea = document.getElementById('chat-input-area');
        const chatSubtitleText = document.getElementById('chat-subtitle-text');
        const actionButtonsArea = document.getElementById('action-buttons-area');

        // ===== 输入联想（搜索建议）=====
        // 说明：页面原本只有 #suggestion-list 的静态结构且 display:none，但没有任何 JS 去控制它显示/渲染
        // 这里补齐“输入时联想框出现”的逻辑（本地模拟数据，后续可替换为接口）
        const SUGGESTIONS = [
            // 考试
            '如何参加考试？',
            '如何报名考试？',
            '考试入口在哪里？',
            '在线考试怎么开始？',
            '考试可以重考吗？',
            '考试成绩在哪里查看？',
            '考试通过标准是多少？',
            '考试时遇到卡顿/黑屏怎么办？',
            '考试提交后还能修改吗？',
            '线下考试怎么预约？',
            '考试注意事项有哪些？',
            '考试题型有哪些？',
            '考试时间不合适可以改期吗？',
            '考试证书多久发放？',

            // 认证
            '如何认证成为高级云架构师？',
            '认证流程是什么？',
            '认证报名条件有哪些？',
            '认证考试费用是多少？',
            '认证有效期多久？如何续证？',
            '认证证书如何下载？',
            '认证进度在哪里查看？',

            // 课程
            '如何报名课程？',
            '课程学习进度如何查看？',
            '课程学习期限是多久？',
            '课程可以重复学习吗？',
            '课程资料在哪里下载？',
            '课程评价怎么写？',
            '课程无法播放怎么办？',
            '课程视频清晰度如何调整？',
            '课程学习记录如何同步？',

            // 直播
            '直播如何预约？',
            '如何进入直播间？',
            '直播开始前会提醒吗？',
            '直播回放在哪里看？',
            '直播资料在哪里下载？',
            '直播弹幕/互动怎么用？',
            '直播卡顿怎么办？',
            '直播错过了还能回看吗？',
            '如何取消直播预约？',

            // 证书
            '如何查看和下载证书',
            '证书如何验证真伪？',
            '证书信息有误如何更正？',
            '证书丢失了怎么办？',

            // 账号与权限
            '忘记密码怎么办？',
            '如何修改手机号/邮箱？',
            '如何绑定/解绑企业信息？',
            '无法登录怎么办？',
            '账号被锁定怎么办？',

            // 下载/驱动/工具
            '如何下载 CPU / DCU ',
            '下载链接失效怎么办？',
            '安装驱动时报错如何解决？',
            '镜像/工具包在哪里下载？',
            '如何获取产品手册/白皮书？',

            // 技术支持
            '如何联系技术支持？',
            '如何提交工单？',
            '工单进度如何查看？',
            '如何反馈问题/建议？'
        ];

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function highlight(text, query) {
            if (!query) return escapeHtml(text);
            const safeText = escapeHtml(text);
            const safeQuery = escapeHtml(query);
            // 简单高亮：大小写不敏感
            const reg = new RegExp(safeQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'ig');
            return safeText.replace(reg, (m) => `<span style="color: #B01F24;">${m}</span>`);
        }

        function hideSuggestions() {
            if (!suggestionList) return;
            suggestionList.style.display = 'none';
            suggestionList.innerHTML = '';
        }

        function showSuggestions(items, query) {
            if (!suggestionList) return;
            if (!items.length) {
                hideSuggestions();
                return;
            }

            suggestionList.innerHTML = items.map((t, idx) => {
                const border = idx === items.length - 1 ? '' : 'border-bottom: 1px solid #f0f0f0;';
                return `
                    <div class="suggestion-item"
                         data-text="${escapeHtml(t)}"
                         style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; ${border} transition: all 0.2s;">
                        ${highlight(t, query)}
                    </div>
                `;
            }).join('');

            suggestionList.style.display = 'block';

            // hover 样式（内联结构下用 JS 绑定更稳）
            suggestionList.querySelectorAll('.suggestion-item').forEach(el => {
                el.addEventListener('mouseenter', () => {
                    el.style.background = '#f8fafc';
                });
                el.addEventListener('mouseleave', () => {
                    el.style.background = 'transparent';
                });
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const text = el.getAttribute('data-text') || '';
                    if (aiInput) {
                        aiInput.value = text;
                        aiInput.focus();
                        // 触发一次 input 以便高度自适应更新
                        aiInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    hideSuggestions();
                });
            });
        }

        function updateSuggestions() {
            if (!aiInput || !suggestionList) return;
            const q = aiInput.value.trim();
            const qLower = q.toLowerCase();

            // 规则：不管输入啥都给联想
            // - 有输入：优先显示匹配项；若匹配不足，用热门推荐补齐；并加入“按你的输入提问”兜底项
            // - 无输入：不显示（避免未输入就弹窗）
            const HOT = SUGGESTIONS.slice(0, 12);

            if (!q) {
                hideSuggestions();
                return;
            }

            let matched = [];
            if (q) {
                matched = SUGGESTIONS.filter(t => t.toLowerCase().includes(qLower));
            }

            let results = [];

            if (q) {
                // 兜底：把用户输入本身作为第一条
                results.push(`按“${q}”提问`);

                // 匹配项（去重）
                matched.slice(0, 8).forEach(t => {
                    if (!results.includes(t)) results.push(t);
                });

                // 热门补齐
                HOT.forEach(t => {
                    if (results.length >= 10) return;
                    if (!results.includes(t)) results.push(t);
                });
                showSuggestions(results, q);
            }
        }
        
        // 右键菜单和多选功能
        const contextMenu = document.getElementById('context-menu');
        const contextMenuMultiselect = document.getElementById('context-menu-multiselect');
        const cancelSelection = document.getElementById('cancel-selection');
        const actionCopy = document.getElementById('action-copy');
        const actionFavorite = document.getElementById('action-favorite');
        const actionShare = document.getElementById('action-share');
        const actionTicket = document.getElementById('action-ticket');
        
        let isMultiSelectMode = false;
        let selectedMessages = new Set();
        let currentMessage = null;
        
        // 我的收藏 & 历史对话数据
        // 收藏项：存储完整对话内容
        let favoriteItems = []; // {id, firstQuestion, messages: [{role: 'user'|'bot', content: string}], createdAt}
        // 历史对话：存储完整对话内容
        let historyItems = [];  // {id, firstQuestion, messages: [{role: 'user'|'bot', content: string}], createdAt}
        let currentConversationId = null; // 当前显示的对话ID
        let conversationIdCounter = 0; // 对话ID计数器
        let currentConversationMessages = []; // 当前对话的消息列表 {role: 'user'|'bot', content: string}
        
        // 灯箱弹窗逻辑
        // 关闭按钮点击事件
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                evaluationModal.style.display = 'flex';
            });
        }

        // 评分星级点击事件
        ratingStars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                selectedRating = rating;
                
                // 更新星级显示
                ratingStars.forEach(s => {
                    if (parseInt(s.getAttribute('data-rating')) <= rating) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            });
        });

        // 弹窗关闭按钮点击事件
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', function() {
                evaluationModal.style.display = 'none';
            });
        }

        // 取消按钮点击事件
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                evaluationModal.style.display = 'none';
                // 返回上一页
                window.location.href = 'index.html';
            });
        }

        // 确定按钮点击事件
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
                const feedback = document.getElementById('feedback-input').value.trim();
                
                // 收集评分和评价数据（这里可以发送到服务器）
                console.log('评分:', selectedRating);
                console.log('评价:', feedback);
                
                // 隐藏弹窗
                evaluationModal.style.display = 'none';
                
                // 显示反馈已收到提示
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #4CAF50;
                    color: white;
                    padding: 16px 32px;
                    border-radius: 4px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    z-index: 99999;
                    font-size: 16px;
                    font-weight: 500;
                    animation: fadeIn 0.3s ease;
                `;
                toast.textContent = '反馈已收到';
                document.body.appendChild(toast);
                
                // 添加动画样式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: translate(-50%, -50%) scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: translate(-50%, -50%) scale(1);
                        }
                    }
                `;
                document.head.appendChild(style);
                
                // 2秒后跳转上一页
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            });
        }

        // 初始化假数据
        function initMockData() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const twoDaysAgo = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
            const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
            
            // 历史对话假数据
            historyItems = [
                {
                    id: 1,
                    firstQuestion: '如何配置DCU开发环境？',
                    messages: [
                        { role: 'user', content: '如何配置DCU开发环境？' },
                        { role: 'bot', content: 'DCU开发环境配置需要以下步骤：\n1. 安装ROCm工具链\n2. 配置环境变量\n3. 验证安装是否成功\n4. 运行测试程序\n\n需要我详细说明每个步骤吗？' },
                        { role: 'user', content: 'ROCm工具链在哪里下载？' },
                        { role: 'bot', content: 'ROCm工具链可以从AMD官网或GitHub下载。推荐使用官方安装包，支持Ubuntu和CentOS系统。您使用的是哪个操作系统？' }
                    ],
                    createdAt: formatDateTime(now)
                },
                {
                    id: 2,
                    firstQuestion: 'CPU性能优化有哪些方法？',
                    messages: [
                        { role: 'user', content: 'CPU性能优化有哪些方法？' },
                        { role: 'bot', content: 'CPU性能优化可以从以下几个方面入手：\n1. 代码层面：算法优化、减少分支预测失败\n2. 编译层面：使用优化编译选项\n3. 系统层面：CPU亲和性设置、NUMA优化\n4. 硬件层面：选择合适的CPU型号\n\n您想了解哪个方面的详细内容？' },
                        { role: 'user', content: 'NUMA优化具体怎么做？' },
                        { role: 'bot', content: 'NUMA优化主要包括：\n1. 使用numactl绑定进程到特定NUMA节点\n2. 分配内存时指定NUMA节点\n3. 避免跨节点访问内存\n4. 监控NUMA统计信息\n\n需要我提供具体的命令示例吗？' }
                    ],
                    createdAt: formatDateTime(yesterday)
                },
                {
                    id: 3,
                    firstQuestion: '云平台如何实现高可用？',
                    messages: [
                        { role: 'user', content: '云平台如何实现高可用？' },
                        { role: 'bot', content: '云平台高可用实现通常包括：\n1. 多可用区部署\n2. 负载均衡\n3. 自动故障转移\n4. 数据备份与恢复\n5. 监控与告警\n\n这些措施可以确保服务在单点故障时仍能正常运行。' }
                    ],
                    createdAt: formatDateTime(twoDaysAgo)
                },
                {
                    id: 4,
                    firstQuestion: '数据库索引优化策略',
                    messages: [
                        { role: 'user', content: '数据库索引优化策略' },
                        { role: 'bot', content: '数据库索引优化策略包括：\n1. 选择合适的索引类型（B-tree、Hash、Bitmap等）\n2. 避免过度索引\n3. 定期分析索引使用情况\n4. 考虑复合索引的顺序\n5. 删除未使用的索引\n\n您的数据库类型是什么？我可以提供更具体的建议。' },
                        { role: 'user', content: 'MySQL的索引优化' },
                        { role: 'bot', content: 'MySQL索引优化要点：\n1. 使用EXPLAIN分析查询计划\n2. 为WHERE、JOIN、ORDER BY字段创建索引\n3. 避免在索引列上使用函数\n4. 使用覆盖索引减少回表\n5. 定期使用OPTIMIZE TABLE优化表\n\n需要我帮您分析具体的查询语句吗？' }
                    ],
                    createdAt: formatDateTime(threeDaysAgo)
                },
                {
                    id: 5,
                    firstQuestion: '操作系统进程调度算法',
                    messages: [
                        { role: 'user', content: '操作系统进程调度算法有哪些？' },
                        { role: 'bot', content: '常见的进程调度算法包括：\n1. 先来先服务（FCFS）\n2. 短作业优先（SJF）\n3. 优先级调度\n4. 时间片轮转（RR）\n5. 多级反馈队列\n\nLinux内核主要使用CFS（完全公平调度器）。您想了解哪种算法的详细实现？' }
                    ],
                    createdAt: formatDateTime(threeDaysAgo)
                }
            ];
            
            // 收藏假数据
            favoriteItems = [
                {
                    id: ++conversationIdCounter,
                    firstQuestion: 'DCU编程最佳实践',
                    messages: [
                        { role: 'user', content: 'DCU编程有哪些最佳实践？' },
                        { role: 'bot', content: 'DCU编程最佳实践包括：\n1. 合理使用共享内存和全局内存\n2. 优化内存访问模式（合并访问）\n3. 使用向量化指令\n4. 避免线程分歧\n5. 合理设置工作组大小\n6. 使用性能分析工具（rocprof）\n\n这些实践可以显著提升DCU程序性能。' },
                        { role: 'user', content: '如何优化内存访问模式？' },
                        { role: 'bot', content: '优化内存访问模式的关键：\n1. 合并访问：让相邻线程访问相邻内存地址\n2. 使用本地内存缓存频繁访问的数据\n3. 避免随机访问模式\n4. 利用内存合并（coalescing）\n5. 减少全局内存访问次数\n\n需要我提供具体的代码示例吗？' }
                    ],
                    createdAt: formatDateTime(yesterday)
                },
                {
                    id: ++conversationIdCounter,
                    firstQuestion: 'CPU向量化优化技巧',
                    messages: [
                        { role: 'user', content: 'CPU向量化优化有哪些技巧？' },
                        { role: 'bot', content: 'CPU向量化优化技巧：\n1. 使用SIMD指令集（SSE、AVX、AVX-512）\n2. 数据对齐到16/32/64字节边界\n3. 循环展开配合向量化\n4. 使用编译器自动向量化选项（-mavx2, -mavx512f）\n5. 避免数据依赖\n6. 使用内联函数优化\n\n这些技巧可以充分利用现代CPU的向量处理能力。' }
                    ],
                    createdAt: formatDateTime(twoDaysAgo)
                },
                {
                    id: ++conversationIdCounter,
                    firstQuestion: '云原生架构设计原则',
                    messages: [
                        { role: 'user', content: '云原生架构的设计原则是什么？' },
                        { role: 'bot', content: '云原生架构的核心设计原则：\n1. 微服务化：将应用拆分为独立服务\n2. 容器化：使用Docker等容器技术\n3. 动态编排：使用Kubernetes等编排工具\n4. DevOps：持续集成和持续部署\n5. 可观测性：日志、监控、追踪\n6. 弹性伸缩：根据负载自动调整资源\n\n这些原则帮助构建高可用、可扩展的云应用。' },
                        { role: 'user', content: '如何实现服务的弹性伸缩？' },
                        { role: 'bot', content: '实现服务弹性伸缩的方法：\n1. 水平扩展：增加或减少实例数量\n2. 垂直扩展：调整单个实例的资源\n3. 使用HPA（水平 Pod 自动扩缩）\n4. 基于CPU、内存、请求数等指标\n5. 设置最小和最大实例数\n6. 预热和冷却时间设置\n\nKubernetes提供了丰富的自动扩缩功能。' }
                    ],
                    createdAt: formatDateTime(threeDaysAgo)
                }
            ];
            
            // 更新计数器，避免ID冲突
            conversationIdCounter = Math.max(
                ...historyItems.map(item => item.id),
                ...favoriteItems.map(item => item.id),
                0
            );
        }
        
        // 当前选中的技能与模式
        let currentSkill = '通用';
        let currentMode = 'qa'; // qa 问答模式；download 下载模式

        // 模式切換 DOM
        const modeToggle = document.getElementById('mode-toggle');
        const modeToggleKnob = document.getElementById('mode-toggle-knob');
        const inputModeTag = document.getElementById('input-mode-tag');
        const inputPlaceholder = document.getElementById('input-placeholder');

        function updateModeUI() {
            if (!modeToggle || !modeToggleKnob || !aiInput || !inputPlaceholder) return;
            if (currentMode === 'qa') {
                modeToggle.classList.remove('mode-download');
                modeToggle.classList.add('mode-qa');
                modeToggleKnob.textContent = '问答';
                inputPlaceholder.textContent = '请输入您的问题...';
                if (inputModeTag) {
                    inputModeTag.textContent = '问答';
                    inputModeTag.style.background = '#4a86ff';
                }
            } else {
                modeToggle.classList.remove('mode-qa');
                modeToggle.classList.add('mode-download');
                modeToggleKnob.textContent = '下载';
                inputPlaceholder.textContent = '请输入需要下载的内容，如“CPU 驱动下载地址”...';
                if (inputModeTag) {
                    inputModeTag.textContent = '下载';
                    inputModeTag.style.background = '#1d4ed8';
                }
            }
        }

        // 处理输入框的聚焦和失焦事件
        if (aiInput && inputPlaceholder) {
            aiInput.addEventListener('input', function() {
                if (aiInput.value.trim() === '') {
                    inputPlaceholder.style.display = 'block';
                } else {
                    inputPlaceholder.style.display = 'none';
                }
            });

            aiInput.addEventListener('focus', function() {
                if (aiInput.value.trim() !== '') {
                    inputPlaceholder.style.display = 'none';
                }
            });

            aiInput.addEventListener('blur', function() {
                if (aiInput.value.trim() === '') {
                    inputPlaceholder.style.display = 'block';
                }
            });
        }

        if (modeToggle) {
            modeToggle.addEventListener('click', function () {
                currentMode = currentMode === 'qa' ? 'download' : 'qa';
                updateModeUI();
            });
            // 初始化一次 UI
            updateModeUI();
        }

        // 下载技能：展开 / 收起二级标签
        const skillSelector = document.getElementById('skill-selector');
        const downloadMain = document.getElementById('download-main');
        const downloadClose = document.getElementById('download-close');

        function toggleDownload(expanded) {
            if (!skillSelector || !downloadMain) return;
            if (expanded) {
                skillSelector.classList.add('expanded');
                downloadMain.classList.add('expanded');
            } else {
                skillSelector.classList.remove('expanded');
                downloadMain.classList.remove('expanded');
            }
        }

        if (downloadMain) {
            downloadMain.addEventListener('click', function(e) {
                // 如果点击的是关闭 X，则直接收起
                if (e.target === downloadClose) {
                    toggleDownload(false);
                    e.stopPropagation();
                    return;
                }
                const isExpanded = downloadMain.classList.contains('expanded');
                toggleDownload(!isExpanded);
            });
        }

        if (downloadClose) {
            downloadClose.addEventListener('click', function(e) {
                toggleDownload(false);
                e.stopPropagation();
            });
        }

        // 二级标签选中样式（CPU / DCU / 云计算）
        const subItems = document.querySelectorAll('.skill-sub-item');
        let currentDownloadTag = '';

        subItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                // 展开状态下点击标签：只高亮当前，取消其他
                subItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentDownloadTag = this.textContent.trim();
            });
        });

        function setPanelsCollapsed(collapsed) {
            if (!chatContainer) return;
            chatContainer.classList.toggle('panels-collapsed', !!collapsed);
        }
        
        // 自动调整文本框高度 + 输入联想
        aiInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight > 120 ? 120 : this.scrollHeight) + 'px';
            updateSuggestions();
        });

        // 聚焦时也尝试展示（如果已有内容）
        aiInput.addEventListener('focus', () => {
            updateSuggestions();
        });

        // 点击外部收起联想
        document.addEventListener('click', (e) => {
            if (!suggestionList) return;
            const target = e.target;
            const clickedInsideSuggestion = suggestionList.contains(target);
            const clickedInsideInput = aiInput && (aiInput === target || aiInput.contains(target));
            if (!clickedInsideSuggestion && !clickedInsideInput) {
                hideSuggestions();
            }
            
            // 点击外部关闭下拉菜单
            const clickedInsideMoreBtn = target.closest('.more-btn');
            const clickedInsideDropdown = target.closest('.dropdown-menu');
            if (!clickedInsideMoreBtn && !clickedInsideDropdown) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
        
        // 添加消息到对话框
        function addMessage(text, isUser = false) {
            if (!aiMessages) {
                console.error('aiMessages 元素不存在');
                return;
            }
            if (!text) {
                console.warn('消息内容为空');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `avatar-small ${isUser ? '' : 'bot-avatar'}`;
            avatarDiv.innerHTML = `<i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-content';
            // 将换行符转换为 <br>，并转义 HTML 以防止 XSS
            const escapedText = escapeHtml(text);
            messageBubble.innerHTML = escapedText.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(messageBubble);
            aiMessages.appendChild(messageDiv);
            
            // 滚动到底部
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // 处理AI回复
        function handleAIResponse(userMessage, skill = '通用') {
            // 模拟AI思考时间
            setTimeout(() => {
                const responses = {
                  '如何参加考试？': `
                    <div class="space-y-3">
                      <p>参加考试的具体流程如下：</p>
                      <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>登录平台，进入"我的考试"页面</li>
                        <li>选择需要参加的考试科目</li>
                        <li>确认考试时间和要求</li>
                        <li>完成在线考试或预约线下考试</li>
                        <li>提交答卷后等待成绩公布</li>
                      </ul>
                      <div class="resource-card">
                        <div class="resource-item">
                          <img src="./images/radio1.png"
                               class="resource-img r-i-radio"
                               alt="考试流程">
                          <div class="resource-info">
                            <div class="resource-title">考试流程详解视频</div>
                            <div class="resource-desc">详细讲解考试报名和参加流程</div>
                          </div>
                          <!--<button class="resource-btn">
                            <i class="fas fa-play"></i> 播放
                          </button>-->
                        </div>
                      </div>
                    </div>
                  `,
                  '如何认证成为高级云架构师？': `
                    <div class="space-y-3">
                      <p>成为高级云架构师的认证路径：</p>
                      <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>具备相关工作经验（3年以上云计算经验）</li>
                        <li>完成高级云架构师培训课程</li>
                        <li>通过理论考试和实操考核</li>
                        <li>提交项目案例和设计方案</li>
                        <li>通过专家评审委员会的审核</li>
                      </ul>
                      <div class="resource-card">
                        <div class="resource-item">
                          <img src="./images/radio2.png"
                               class="resource-img  r-i-radio"
                               alt="云架构师认证">
                          <div class="resource-info">
                            <div class="resource-title">高级云架构师认证指南</div>
                            <div class="resource-desc">完整认证流程和备考策略</div>
                          </div>
                          <!--<button class="resource-btn">
                            <i class="fas fa-play"></i> 播放
                          </button>-->
                        </div>
                      </div>
                    </div>
                  `,
                  '如何查看和下载证书': `
                    <div class="space-y-3">
                      <p>查看和下载证书的操作步骤：</p>
                      <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>登录个人中心，进入"我的证书"页面</li>
                        <li>查看已获得的证书列表</li>
                        <li>点击证书查看详细信息</li>
                        <li>选择下载格式（PDF/图片）</li>
                        <li>验证证书真伪（可选）</li>
                      </ul>
                      <div class="resource-card">
                        <div class="resource-item">
                          <img src="./images/radio2.png"
                               class="resource-img r-i-radio"
                               alt="证书管理">
                          <div class="resource-info">
                            <div class="resource-title">证书管理操作教程</div>
                            <div class="resource-desc">详细演示证书查看和下载流程</div>
                          </div>
                          <!--<button class="resource-btn">
                            <i class="fas fa-play"></i> 播放
                          </button>-->
                        </div>
                      </div>
                    </div>
                  `,
                  '在线学习': '您可以通过平台的「课程学习」或「培训中心」模块，选择适合您的在线课程进行自主学习。支持视频课程、实验课程和配套资料下载。<div style="margin-top: 16px;"><img src="https://picsum.photos/id/3/400/200" alt="在线学习平台" style="max-width: 100%; max-height: 90px; object-fit: cover; border-radius: 8px;"></div>',
                  '认证其他问题': '如果您在认证过程中遇到其他问题，可以在「帮助与支持」或「工单中心」中发起问题单，我们会有专人进行跟进并答复。',
                  '证书申请流程': '通过考试后，系统会自动生成您的认证信息。您需要完善个人资料并提交证书申请，审核通过后即可在线查看与下载电子证书。',
                  'HCIE实验预约及考位查询': 'HCIE 实验考试需要提前在考试中心进行预约，您可以在「我的考试」中查看可预约考位与时间，并完成缴费后确认。',
                  '认证考试证书有效期': '大部分认证证书有效期为 3 年，具体以认证项目规则为准。您可以在「我的证书」中查看每张证书的有效期与到期提醒。',
                  '取消考试政策': '对于已预约的考试，如需取消或改期，请在考试规定时间前在「我的考试」中操作，逾期将可能无法退款或需要支付改期费用。',
                  '服务器产品介绍': '曙光服务器产品线丰富，涵盖多种应用场景：\n1. 通用服务器：适用于企业日常业务处理\n2. 高性能计算服务器：专为科学计算、AI训练等场景设计\n3. 存储服务器：提供大容量、高可靠性的数据存储解决方案\n4. 边缘服务器：满足边缘计算低延迟、高可靠性需求\n5. 液冷服务器：通过液冷技术实现高效散热，降低能耗\n\n每个系列都有多种配置可选，满足不同规模企业的需求。<div style="margin-top: 16px;"><img src="https://picsum.photos/id/3/400/200" alt="服务器产品" style="max-width: 100%; max-height: 90px; object-fit: cover; border-radius: 8px;"></div>',
                  '服务器配置方案': '选择服务器配置需要考虑以下因素：\n1. 业务类型：不同业务对CPU、内存、存储的需求不同\n2. 性能要求：根据并发用户数、数据处理量等评估\n3. 扩展性：预留未来业务增长的扩展空间\n4. 可靠性：关键业务需要考虑冗余设计\n5. 成本预算：在满足需求的前提下控制成本\n\n我们提供定制化配置方案，根据您的具体需求推荐最适合的服务器配置。<div style="margin-top: 16px;"><img src="https://picsum.photos/id/3/400/200" alt="服务器配置方案" style="max-width: 100%; max-height: 90px; object-fit: cover; border-radius: 8px;"></div>',
                  '服务器技术支持': '曙光服务器提供全方位技术支持服务：\n1. 7×24小时远程技术支持\n2. 现场服务：根据服务级别提供不同响应时间的现场支持\n3. 备件服务：快速备件更换，减少停机时间\n4. 技术培训：为您的IT团队提供服务器维护培训\n5. 定期巡检：预防性维护，提前发现并解决潜在问题\n\n我们的技术支持团队由经验丰富的工程师组成，确保您的服务器系统稳定运行。<div style="margin-top: 16px;"><img src="https://picsum.photos/id/3/400/200" alt="服务器技术支持" style="max-width: 100%; max-height: 90px; object-fit: cover; border-radius: 8px;"></div>',

                  // 进阶提问固定回答
                  '考试报名入口在哪里？': '您可以在平台顶部导航进入「考试中心」或「我的考试」，在「可报名考试」列表中点击对应考试右侧的“立即报名”按钮完成报名。',
                  '考试报名有哪些条件限制？': '不同考试的报名条件不同，一般包括：已完成指定先修课程、满足工作年限要求以及通过前置级别考试等，具体可在考试详情页查看。',
                  '如何查看考试成绩与证书获取情况？': '考试结束后，您可以在「我的考试」中查看成绩，在「我的证书」模块查看是否已生成对应证书及其状态。',

                  '高级云架构师培训课有哪些学习路径？': '通常包括基础云计算课程、高级架构设计课程以及实践项目课程，建议按“基础理论→核心技能→场景实践”的路径进行学习。',
                  '高级云架构师考试都考哪些内容？': '考试一般覆盖云基础架构设计、网络与安全、性能与高可用、成本优化以及典型行业场景设计等内容，具体以考试大纲为准。',

                  '证书到期前需要做哪些准备？': '建议提前 3-6 个月关注证书到期时间，了解重认证规则，规划好补修课程或重认证考试，避免证书失效影响个人资质。'
                };

                // 每个主问题对应的进阶推荐问题列表
                const followupsMap = {
                  '如何参加考试？': [
                    '考试报名入口在哪里？',
                    '考试报名有哪些条件限制？',
                    '如何查看考试成绩与证书获取情况？'
                  ],
                  '如何认证成为高级云架构师？': [
                    '高级云架构师培训课有哪些学习路径？',
                    '高级云架构师考试都考哪些内容？'
                  ],
                  '如何查看和下载证书': [
                    '证书到期前需要做哪些准备？',
                    '认证考试证书有效期'
                  ]
                };
                
                const response = responses[userMessage] || '感谢您的提问！我会尽力为您提供帮助。如果您有更具体的问题，请详细描述，我会给出更精准的回答。';
                addMessage(response, false);
                addAIResponseToConversation(response);

                // 在回答后添加红框提示框
                const helpBox = document.createElement('div');
                helpBox.className = 'permission-help-box';
                helpBox.innerHTML = `
                    <div class="permission-help-text">我可以把这些内容整理成简洁的表格版，方便你快速查阅，需要吗？</div>
                    <div class="inline-actions">
                        <button class="line-action-btn like-btn" title="点赞"><i class="far fa-thumbs-up"></i></button>
                        <button class="line-action-btn favorite-btn" title="收藏"><i class="far fa-star"></i></button>
                    </div>
                `;
                aiMessages.appendChild(helpBox);
                
                aiMessages.scrollTop = aiMessages.scrollHeight;

                // 在回答下方追加进阶问题推荐
                const followups = followupsMap[userMessage];
                if (followups && followups.length) {
                    const container = document.createElement('div');
                    container.className = 'followups-container';
                    
                    followups.forEach(text => {
                        const btn = document.createElement('button');
                        btn.className = 'followup-btn';
                        btn.innerHTML = `<span>${text}</span><i class="fas fa-arrow-right followup-icon"></i>`;
                        btn.addEventListener('click', () => {
                            addMessage(text, true);
                            addHistoryItem(text);
                            handleAIResponse(text, currentSkill);
                        });
                        container.appendChild(btn);
                    });

                    aiMessages.appendChild(container);
                    aiMessages.scrollTop = aiMessages.scrollHeight;
                }

                // 回答后收起上方卡片区域，给对话腾出空间
                setPanelsCollapsed(true);
                
                // 保存对话到历史记录
                saveCurrentConversation();
            }, 1000);
        }

        // 发送按钮点击事件
        if (aiSend) {
            aiSend.addEventListener('click', function() {
                const message = aiInput.value.trim();
                if (message) {
                    // 如果是新对话（currentConversationId为null且当前有消息），先保存之前的对话
                    if (currentConversationId === null && currentConversationMessages.length > 0) {
                        saveCurrentConversation();
                    }
                    // 在消息前添加技能标签（可选，用于显示）
                    const messageWithSkill = currentSkill !== '通用' ? `[${currentSkill}] ${message}` : message;
                    addMessage(messageWithSkill, true);
                    addHistoryItem(message);
                    // 发送后先收起（等回复出现时也会再次确保收起）
                    setPanelsCollapsed(true);
                    aiInput.value = '';
                    aiInput.style.height = 'auto';
                    handleAIResponse(message, currentSkill);
                }
            });
        }

        // 输入框回车发送
        if (aiInput) {
            aiInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    aiSend.click();
                }
            });
        }
        
        // 点击输入框时，不再自动展示下载技能选择器（按需手动扩展）

        // 预设标签点击事件（底部快捷问题）
        const presetButtons = document.querySelectorAll('#ai-quick-questions button');
        presetButtons.forEach(button => {
            button.addEventListener('click', function() {
                const message = this.textContent.trim();
                addMessage(message, true);
                addHistoryItem(message);
                setPanelsCollapsed(true);
                handleAIResponse(message, currentSkill);
            });
        });

        function formatDateTime(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${hh}:${mm}`;
        }

        // 渲染收藏二级菜单
        function renderFavoritesSubmenu() {
            const submenu = document.getElementById('favorites-submenu');
            if (!submenu) return;
            if (favoriteItems.length === 0) {
                submenu.innerHTML = '<div style="padding: 8px 12px; color: #9ca3af; font-size: 12px;">暂无收藏</div>';
                return;
            }
            
            // 清空子菜单
            submenu.innerHTML = '';
            
            // 为每个收藏项创建DOM元素
            favoriteItems.forEach(item => {
                console.log('创建收藏项:', item.id);
                
                // 创建收藏项容器
                const favoriteItem = document.createElement('div');
                favoriteItem.className = 'sidebar-submenu-item';
                favoriteItem.setAttribute('data-id', item.id);
                favoriteItem.setAttribute('data-type', 'favorite');
                
                // 创建内容区域
                const content = document.createElement('div');
                content.className = 'sidebar-submenu-item-content';
                content.textContent = item.firstQuestion;
                favoriteItem.appendChild(content);
                
                // 创建操作区域
                const actions = document.createElement('div');
                actions.className = 'sidebar-submenu-item-actions';
                
                // 创建更多按钮
                const moreBtn = document.createElement('div');
                moreBtn.className = 'more-btn';
                moreBtn.setAttribute('data-id', item.id);
                moreBtn.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
                actions.appendChild(moreBtn);
                
                // 创建下拉菜单
                const dropdown = document.createElement('div');
                dropdown.className = 'dropdown-menu';
                dropdown.setAttribute('data-id', item.id);
                
                // 创建重命名菜单项
                const renameItem = document.createElement('div');
                renameItem.className = 'dropdown-item rename-item';
                renameItem.setAttribute('data-id', item.id);
                renameItem.innerHTML = '<i class="fas fa-edit"></i><span>重命名</span>';
                dropdown.appendChild(renameItem);
                
                // 创建删除菜单项
                const deleteItem = document.createElement('div');
                deleteItem.className = 'dropdown-item delete-item';
                deleteItem.setAttribute('data-id', item.id);
                deleteItem.innerHTML = '<i class="fas fa-trash"></i><span>删除</span>';
                dropdown.appendChild(deleteItem);
                
                actions.appendChild(dropdown);
                favoriteItem.appendChild(actions);
                submenu.appendChild(favoriteItem);
                
                // 为更多按钮添加点击事件
                moreBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('点击收藏更多按钮:', item.id);
                    
                    // 关闭其他所有下拉菜单
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('show');
                    });
                    
                    // 显示当前下拉菜单
                    dropdown.classList.add('show');
                    console.log('显示收藏下拉菜单:', dropdown);
                });
                
                // 为重命名菜单项添加点击事件
                renameItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('点击收藏重命名:', item.id);
                    renameConversation(item.id);
                    dropdown.classList.remove('show');
                });
                
                // 为删除菜单项添加点击事件
                deleteItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('点击收藏删除:', item.id);
                    deleteConversation(item.id);
                    dropdown.classList.remove('show');
                });
            });
            
            console.log('渲染完成后favorites-submenu.innerHTML:', submenu.innerHTML);
        }
        
        // 渲染历史对话二级菜单
        function renderHistorySubmenu() {
            console.log('进入renderHistorySubmenu函数');
            const submenu = document.getElementById('history-submenu');
            console.log('submenu元素:', submenu);
            if (!submenu) {
                console.log('submenu元素不存在');
                return;
            }
            console.log('historyItems长度:', historyItems.length);
            if (historyItems.length === 0) {
                console.log('historyItems为空，显示暂无历史对话');
                submenu.innerHTML = '<div style="padding: 8px 12px; color: #9ca3af; font-size: 12px;">暂无历史对话</div>';
                return;
            }
            console.log('historyItems内容:', historyItems);
            
            // 清空子菜单
            submenu.innerHTML = '';
            
            // 为每个历史项创建DOM元素
            historyItems.forEach(item => {
                console.log('创建历史项:', item.id);
                
                // 创建历史项容器
                const historyItem = document.createElement('div');
                historyItem.className = 'sidebar-submenu-item';
                historyItem.setAttribute('data-id', item.id);
                historyItem.setAttribute('data-type', 'history');
                
                // 创建内容区域
                const content = document.createElement('div');
                content.className = 'sidebar-submenu-item-content';
                content.textContent = item.firstQuestion;
                historyItem.appendChild(content);
                
                // 创建操作区域
                const actions = document.createElement('div');
                actions.className = 'sidebar-submenu-item-actions';
                
                // 创建更多按钮
                const moreBtn = document.createElement('div');
                moreBtn.className = 'more-btn';
                moreBtn.setAttribute('data-id', item.id);
                moreBtn.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
                actions.appendChild(moreBtn);
                
                // 创建下拉菜单
                const dropdown = document.createElement('div');
                dropdown.className = 'dropdown-menu';
                dropdown.setAttribute('data-id', item.id);
                
                // 创建收藏菜单项
                const favoriteItem = document.createElement('div');
                favoriteItem.className = 'dropdown-item favorite-item';
                favoriteItem.setAttribute('data-id', item.id);
                favoriteItem.innerHTML = '<i class="fas fa-star"></i><span>收藏</span>';
                dropdown.appendChild(favoriteItem);
                
                // 创建重命名菜单项
                const renameItem = document.createElement('div');
                renameItem.className = 'dropdown-item rename-item';
                renameItem.setAttribute('data-id', item.id);
                renameItem.innerHTML = '<i class="fas fa-edit"></i><span>重命名</span>';
                dropdown.appendChild(renameItem);
                
                // 创建删除菜单项
                const deleteItem = document.createElement('div');
                deleteItem.className = 'dropdown-item delete-item';
                deleteItem.setAttribute('data-id', item.id);
                deleteItem.innerHTML = '<i class="fas fa-trash"></i><span>删除</span>';
                dropdown.appendChild(deleteItem);
                
                actions.appendChild(dropdown);
                historyItem.appendChild(actions);
                submenu.appendChild(historyItem);
                
                // 为更多按钮添加点击事件
                moreBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('点击更多按钮:', item.id);
                    
                    // 关闭其他所有下拉菜单
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('show');
                    });
                    
                    // 显示当前下拉菜单
                    dropdown.classList.add('show');
                    console.log('显示下拉菜单:', dropdown);
                });
                
                // 为收藏菜单项添加点击事件
                favoriteItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('点击收藏:', item.id);
                    favoriteConversation(item.id);
                    dropdown.classList.remove('show');
                });
                
                // 为重命名菜单项添加点击事件
                renameItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('点击重命名:', item.id);
                    renameConversation(item.id);
                    dropdown.classList.remove('show');
                });
                
                // 为删除菜单项添加点击事件
                deleteItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('点击删除:', item.id);
                    deleteConversation(item.id);
                    dropdown.classList.remove('show');
                });
            });
            
            console.log('渲染完成后submenu.innerHTML:', submenu.innerHTML);
        }

        function addHistoryItem(question) {
            if (!question) return;
            // 如果是新对话（currentConversationId为null），创建新对话
            if (currentConversationId === null) {
                currentConversationId = ++conversationIdCounter;
                currentConversationMessages = [];
            }
            // 添加用户消息
            currentConversationMessages.push({
                role: 'user',
                content: question
            });
        }
        
        // 保存当前对话到历史记录
        function saveCurrentConversation() {
            if (currentConversationId === null || currentConversationMessages.length === 0) return;
            const firstQuestion = currentConversationMessages.find(m => m.role === 'user')?.content || '';
            if (!firstQuestion) return;
            
            // 检查对话是否已存在
            const existingIndex = historyItems.findIndex(item => item.id === currentConversationId);
            const now = new Date();
            
            if (existingIndex !== -1) {
                // 更新现有对话
                historyItems[existingIndex] = {
                    id: currentConversationId,
                    firstQuestion: firstQuestion,
                    messages: [...currentConversationMessages],
                    createdAt: historyItems[existingIndex].createdAt // 保持原创建时间
                };
                // 移到最前面
                const updated = historyItems.splice(existingIndex, 1)[0];
                historyItems.unshift(updated);
            } else {
                // 创建新对话
                historyItems.unshift({
                    id: currentConversationId,
                    firstQuestion: firstQuestion,
                    messages: [...currentConversationMessages],
                    createdAt: formatDateTime(now)
                });
            }
            // 只保留最近 20 条
            historyItems = historyItems.slice(0, 20);
            renderHistorySubmenu();
        }
        
        // 添加AI回复到当前对话
        function addAIResponseToConversation(response) {
            if (currentConversationId !== null) {
                currentConversationMessages.push({
                    role: 'bot',
                    content: response
                });
            }
        }

        // 加载对话内容
        function loadConversation(id, type) {
            console.log('加载对话，id:', id, 'type:', type, 'id类型:', typeof id);
            const items = type === 'favorite' ? favoriteItems : historyItems;
            console.log('可用对话数量:', items.length);
            console.log('对话ID列表:', items.map(item => ({ id: item.id, type: typeof item.id })));
            const conversation = items.find(item => item.id == id || item.id === parseInt(id) || String(item.id) === String(id));
            if (!conversation) {
                console.error('未找到对话，id:', id, 'type:', type);
                return;
            }
            
            // 保存当前对话
            saveCurrentConversation();
            
            // 清除选中状态
            selectedMessages.clear();
            // 安全地退出多选模式
            if (typeof exitMultiSelectMode === 'function') {
                try {
                    exitMultiSelectMode();
                } catch (e) {
                    console.warn('退出多选模式时出错:', e);
                }
            }
            // 确保isMultiSelectMode为false
            isMultiSelectMode = false;
            
            // 确保面板可见
            if (panelChat) {
                panelChat.style.display = 'flex';
            }
            
            // 清空右侧内容
            if (aiMessages) {
                aiMessages.innerHTML = '';
            }
            
            // 显示聊天记录（上面部分）
            if (aiMessages && conversation.messages && conversation.messages.length > 0) {
                conversation.messages.forEach((msg) => {
                    if (msg && msg.content) {
                        const isUser = msg.role === 'user';
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
                        
                        const avatarDiv = document.createElement('div');
                        avatarDiv.className = `avatar-small ${isUser ? '' : 'bot-avatar'}`;
                        avatarDiv.innerHTML = `<i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>`;
                        
                        const messageBubble = document.createElement('div');
                        messageBubble.className = 'message-content';
                        const escapedText = escapeHtml(msg.content);
                        messageBubble.innerHTML = escapedText.replace(/\n/g, '<br>');
                        
                        messageDiv.appendChild(avatarDiv);
                        messageDiv.appendChild(messageBubble);
                        aiMessages.appendChild(messageDiv);
                    }
                });
                
                // 滚动到底部
                setTimeout(() => {
                    if (aiMessages) {
                        aiMessages.scrollTop = aiMessages.scrollHeight;
                    }
                }, 50);
            }
            
            // 调试日志
            console.log('调试信息:');
            console.log('chatInputArea:', chatInputArea);
            console.log('inputArea:', inputArea);
            console.log('actionButtonsArea:', actionButtonsArea);
            console.log('aiMessages:', aiMessages);
            console.log('selectedMessages.size:', selectedMessages.size);
            console.log('isMultiSelectMode:', isMultiSelectMode);
            
            // 强制显示聊天输入框区域（下面部分），确保它显示在历史对话底部
            console.log('强制显示输入区域...');
            console.log('chatInputArea元素:', chatInputArea);
            console.log('inputArea元素:', inputArea);
            
            // 确保输入区域的父容器#panel-chat是flex布局
            if (panelChat) {
                console.log('设置panelChat样式...');
                panelChat.style.display = 'flex';
                panelChat.style.flexDirection = 'column';
            }
            
            // 显示输入区域
            if (chatInputArea) {
                console.log('设置chatInputArea.display = block');
                chatInputArea.style.display = 'block';
                chatInputArea.style.position = 'relative';
                chatInputArea.style.zIndex = '10';
                chatInputArea.style.flexShrink = '0';
            } else {
                console.log('chatInputArea为null');
            }
            
            if (inputArea) {
                console.log('设置inputArea.display = block');
                inputArea.style.display = 'block';
                inputArea.style.position = 'relative';
                inputArea.style.zIndex = '10';
                inputArea.style.flexShrink = '0';
            } else {
                console.log('inputArea为null');
            }
            
            if (actionButtonsArea) {
                console.log('设置actionButtonsArea.display = none');
                actionButtonsArea.style.display = 'none';
            } else {
                console.log('actionButtonsArea为null');
            }
            
            // 确保消息区域在正确的位置
            if (aiMessages) {
                console.log('设置aiMessages样式...');
                aiMessages.style.flex = '1';
                aiMessages.style.minHeight = '0';
                aiMessages.style.overflowY = 'auto';
            } else {
                console.log('aiMessages为null');
            }
            
            console.log('输入区域显示设置完成');
            
            
            // 切换到聊天面板
            console.log('调用switchPanel(\'chat\')');
            switchPanel('chat');
            
            // 再次确保输入区域显示（防止被switchPanel覆盖）
            setTimeout(() => {
                console.log('再次确保输入区域显示...');
                if (chatInputArea) {
                    chatInputArea.style.display = 'block';
                    chatInputArea.style.position = 'relative';
                    chatInputArea.style.zIndex = '10';
                    chatInputArea.style.flexShrink = '0';
                }
                if (inputArea) {
                    inputArea.style.display = 'block';
                    inputArea.style.position = 'relative';
                    inputArea.style.zIndex = '10';
                    inputArea.style.flexShrink = '0';
                }
                console.log('输入区域显示确认完成');
            }, 100);
            
            // 高亮选中的二级菜单项
            document.querySelectorAll('.sidebar-submenu-item').forEach(item => {
                item.classList.remove('active');
            });
            const selectedItem = document.querySelector(`.sidebar-submenu-item[data-id="${id}"][data-type="${type}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // 设置当前对话ID和消息
            currentConversationId = id;
            currentConversationMessages = conversation.messages ? [...conversation.messages] : [];
            
            console.log('对话加载完成');
        }
        
        // 侧边栏：新对话 / 我的收藏 / 历史对话 切换

        function switchPanel(target) {
            // 按钮高亮（只处理新对话按钮）
            if (target === 'chat') {
                sidebarButtons.forEach(btn => {
                    if (btn.getAttribute('data-target') === 'chat') {
                        btn.classList.add('active');
                    } else if (!btn.classList.contains('sidebar-btn-expandable')) {
                        btn.classList.remove('active');
                    }
                });
            }

            // 面板显示/隐藏
            if (panelChat) panelChat.style.display = (target === 'chat') ? 'flex' : 'none';
            
            // 输入框显示逻辑：在聊天模式下，总是显示输入区域
            if (target === 'chat') {
                // 确保输入框显示
                if (chatInputArea) {
                    chatInputArea.style.display = 'block';
                }
                if (inputArea) {
                    inputArea.style.display = 'block';
                }
                if (actionButtonsArea) {
                    actionButtonsArea.style.display = (selectedMessages.size > 0) ? 'flex' : 'none';
                }
            } else {
                // 非聊天模式，隐藏输入框和操作按钮
                if (chatInputArea) chatInputArea.style.display = 'none';
                if (inputArea) inputArea.style.display = 'none';
                if (actionButtonsArea) actionButtonsArea.style.display = 'none';
            }

            // 头部副标题文案
            if (chatSubtitleText) {
                if (target === 'chat') {
                    chatSubtitleText.textContent = '问你所惑，解你所需';
                }
            }
        }

        if (sidebarButtons.length) {
            sidebarButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const target = this.getAttribute('data-target') || 'chat';
                    
                    // 如果是可展开的按钮（收藏/历史对话）
                    if (this.classList.contains('sidebar-btn-expandable')) {
                        // 切换展开状态
                        this.classList.toggle('expanded');
                        const submenuId = target + '-submenu';
                        const submenu = document.getElementById(submenuId);
                        const arrow = this.querySelector('.sidebar-btn-arrow');
                        if (submenu) {
                            if (this.classList.contains('expanded')) {
                                submenu.style.display = 'flex';
                                // 渲染二级菜单
                                if (target === 'favorites') {
                                    renderFavoritesSubmenu();
                                } else if (target === 'history') {
                                    renderHistorySubmenu();
                                }
                                // 切换箭头为向下
                                if (arrow) {
                                    arrow.classList.remove('fa-chevron-up');
                                    arrow.classList.add('fa-chevron-down');
                                }
                            } else {
                                submenu.style.display = 'none';
                                // 切换箭头为向上
                                if (arrow) {
                                    arrow.classList.remove('fa-chevron-down');
                                    arrow.classList.add('fa-chevron-up');
                                }
                            }
                        }
                        // 切换按钮高亮
                        sidebarButtons.forEach(b => {
                            if (b !== this && b.getAttribute('data-target') !== 'chat') {
                                b.classList.remove('active');
                            }
                        });
                        this.classList.toggle('active');
                    } else {
                        // 普通按钮（新对话）
                        if (target === 'chat') {
                            // 保存当前对话
                            saveCurrentConversation();
                            // 重置对话状态
                            currentConversationId = null;
                            currentConversationMessages = [];
                            // 清除二级菜单选中状态
                            document.querySelectorAll('.sidebar-submenu-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            // 恢复初始状态：清除消息并重新添加欢迎消息和卡片
                            if (aiMessages) {
                                aiMessages.innerHTML = `
                                    <div class="message bot-message">
                                        <div class="avatar-small bot-avatar">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="message-content">
                                            您好！我是AI智能助手，展示认证流程，包括考试预约、获取与验证证书的入口，以及可能涉及的重认证规则。有什么可以帮助您的吗？
                                        </div>
                                    </div>
                                    <div class="ability-panels">
                                        <div class="ability-card">
                                            <div class="ability-card-header">
                                                <span class="ability-card-title">场景领域</span>
                                            </div>
                                            <div class="ability-list">
                                                <button class="ability-item scene-domain-item" data-question="DCU 驱动下载">
                                                    <div class="ability-item-title">DCU</div>
                                                    <div class="ability-item-subtitle">获取最新 DCU 驱动与工具</div>
                                                </button>
                                                <button class="ability-item scene-domain-item" data-question="CPU 固件与驱动下载">
                                                    <div class="ability-item-title">CPU</div>
                                                    <div class="ability-item-subtitle">CPU 固件、驱动及文档资源</div>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="ability-card">
                                            <div class="ability-card-header">
                                                <span class="ability-card-title">推广</span>
                                                <div class="ability-card-page">
                                                    <span>2/3</span>
                                                    <i class="fas fa-angle-right"></i>
                                                </div>
                                            </div>
                                            <div class="ability-list">
                                                <button class="ability-item" data-question="在线学习">
                                                    <div class="ability-item-title">在线学习</div>
                                                    <div class="ability-item-subtitle">学习在线课程</div>
                                                </button>
                                                <button class="ability-item" data-question="认证其他问题">
                                                    <div class="ability-item-title">认证其他问题</div>
                                                    <div class="ability-item-subtitle">发起问题单</div>
                                                </button>
                                                <button class="ability-item" data-question="证书申请流程">
                                                    <div class="ability-item-title">证书申请流程</div>
                                                    <div class="ability-item-subtitle">认证证书申请流程</div>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="ability-card">
                                            <div class="ability-card-header">
                                                <span class="ability-card-title">Q&A</span>
                                            </div>
                                            <div class="guess-questions">
                                                <button class="guess-question" data-question="HCIE实验预约及考位查询">实验预约及考位查询</button>
                                                <button class="guess-question" data-question="认证考试证书有效期">认证考试证书有效期</button>
                                                <button class="guess-question" data-question="取消考试政策">取消考试政策</button>
                                            </div>
                                            <div class="guess-banner">
                                                <div class="guess-banner-content">
                                                    <div class="guess-banner-title">全新焕变</div>
                                                    <div class="guess-banner-subtitle">能力升级 AI 问答更懂你</div>
                                                </div>
                                                <div class="guess-banner-action">
                                                    <i class="fas fa-arrow-right"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                // 重新绑定事件
                                bindAbilityItems();
                                bindPanelButtons();
                            }
                            // 确保输入框显示
                            selectedMessages.clear();
                            if (chatInputArea) {
                                chatInputArea.style.display = 'block';
                            }
                            if (actionButtonsArea) {
                                actionButtonsArea.style.display = 'none';
                            }
                        }
                        switchPanel(target);
                    }
                });
            });
        }

        // 初始化假数据
        initMockData();
        
        // 调试日志：检查历史对话数据
        console.log('初始化历史对话前:');
        console.log('historyItems:', historyItems);
        console.log('historyItems.length:', historyItems.length);
        
        // 默认展开历史对话并渲染
        const historyButton = document.querySelector('.sidebar-btn[data-target="history"]');
        const historySubmenu = document.getElementById('history-submenu');
        console.log('historyButton:', historyButton);
        console.log('historySubmenu:', historySubmenu);
        
        if (historyButton && historySubmenu) {
            console.log('执行历史对话展开操作');
            // 确保历史对话按钮为展开状态
            historyButton.classList.add('expanded');
            // 确保历史对话子菜单显示
            historySubmenu.style.display = 'flex';
            // 确保历史对话箭头为向下（展开状态）
            const historyArrow = historyButton.querySelector('.sidebar-btn-arrow');
            if (historyArrow) {
                historyArrow.classList.remove('fa-chevron-up');
                historyArrow.classList.add('fa-chevron-down');
            }
            // 渲染历史对话列表
            console.log('调用renderHistorySubmenu()');
            renderHistorySubmenu();
            console.log('历史对话展开完成');
        } else {
            console.log('历史对话元素获取失败');
        }
        
        // 内联事件处理，无需手动绑定
        
        // 使用事件委托处理二级菜单项点击
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.addEventListener('click', function(e) {
                // 检查是否点击了更多按钮或下拉菜单项
                const moreBtn = e.target.closest('.more-btn');
                const dropdownItem = e.target.closest('.dropdown-item');
                if (moreBtn || dropdownItem) {
                    // 不执行任何操作，让事件冒泡到对应的监听器
                    return;
                }
                
                const submenuItem = e.target.closest('.sidebar-submenu-item');
                if (submenuItem) {
                    e.preventDefault();
                    e.stopPropagation();
                    const id = parseInt(submenuItem.getAttribute('data-id'));
                    const type = submenuItem.getAttribute('data-type');
                    console.log('点击二级菜单项，id:', id, 'type:', type);
                    if (id && type) {
                        loadConversation(id, type);
                    }
                }
            });
        }
        
        // 默认展示新对话面板
        switchPanel('chat');

        // 绑定能力项事件
        function bindAbilityItems() {
            // 场景领域标签（仅高亮，不触发会话）
            const sceneDomainItems = document.querySelectorAll('.scene-domain-item');
            const selectedSceneDomain = document.getElementById('selected-scene-domain');
            const selectedSceneDomainText = document.getElementById('selected-scene-domain-text');
            const selectedSceneDomainClose = document.getElementById('selected-scene-domain-close');
            let currentSceneDomain = '';
            sceneDomainItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    // 只作为标签选中展示
                    sceneDomainItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    // 标签只保留 DCU / CPU 文本，不带描述
                    const titleEl = this.querySelector('.ability-item-title');
                    currentSceneDomain = titleEl ? titleEl.textContent.trim() : this.textContent.trim();

                    // 在输入框上方显示当前选中领域
                    if (selectedSceneDomain && selectedSceneDomainText) {
                        selectedSceneDomain.style.display = 'block';
                        selectedSceneDomainText.textContent = currentSceneDomain;
                    }

                    // 切换到下载模式，但不发送消息
                    currentMode = 'download';
                    updateModeUI();
                });
            });
        }

        // 关闭已选领域标签
        const selectedSceneDomainClose = document.getElementById('selected-scene-domain-close');
        if (selectedSceneDomainClose) {
            selectedSceneDomainClose.addEventListener('click', function () {
                // 清空当前选中状态
                currentSceneDomain = '';
                const selectedSceneDomain = document.getElementById('selected-scene-domain');
                const selectedSceneDomainText = document.getElementById('selected-scene-domain-text');
                const sceneDomainItems = document.querySelectorAll('.scene-domain-item');
                if (selectedSceneDomain) {
                    selectedSceneDomain.style.display = 'none';
                }
                if (selectedSceneDomainText) {
                    selectedSceneDomainText.textContent = '';
                }
                if (sceneDomainItems) {
                    sceneDomainItems.forEach(i => i.classList.remove('active'));
                }
                // 可选：关闭后仍保持下载模式，不切回问答
            });
        }

        // 绑定能力项和猜你想问按钮的事件
        function bindPanelButtons() {
            // 能力场景 & 猜你想问卡片点击事件（不包含场景领域标签）
            const panelButtons = document.querySelectorAll('.ability-item:not(.scene-domain-item), .guess-question');
            panelButtons.forEach(button => {
                // 移除旧的事件监听器（如果存在）
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                // 添加新的事件监听器
                newButton.addEventListener('click', function() {
                    const message = this.getAttribute('data-question') || this.textContent.trim();
                    addMessage(message, true);
                    addHistoryItem(message);
                    setPanelsCollapsed(true);
                    handleAIResponse(message, currentSkill);
                });
            });
        }
        
        // 绑定更多按钮事件
        function bindMoreButtons() {
            console.log('开始绑定更多按钮事件');
            const moreButtons = document.querySelectorAll('.more-btn');
            console.log('找到的更多按钮数量:', moreButtons.length);
            
            // 为每个更多按钮添加点击事件
            moreButtons.forEach(button => {
                console.log('绑定按钮事件:', button);
                
                // 移除旧的事件监听器
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // 添加新的事件监听器
                newButton.addEventListener('click', function(e) {
                    console.log('点击更多按钮:', this);
                    e.preventDefault();
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    console.log('按钮ID:', id);
                    const dropdown = document.querySelector(`.dropdown-menu[data-id="${id}"]`);
                    console.log('找到的下拉菜单:', dropdown);
                    
                    // 关闭其他所有下拉菜单
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        if (menu.getAttribute('data-id') !== id) {
                            menu.classList.remove('show');
                        }
                    });
                    
                    // 切换当前下拉菜单
                    if (dropdown) {
                        console.log('切换下拉菜单显示状态');
                        dropdown.classList.toggle('show');
                        console.log('切换后状态:', dropdown.classList.contains('show'));
                    }
                });
            });
            
            // 为每个下拉菜单项添加点击事件
            const dropdownItems = document.querySelectorAll('.dropdown-item');
            console.log('找到的下拉菜单项数量:', dropdownItems.length);
            dropdownItems.forEach(item => {
                console.log('绑定菜单项事件:', item);
                
                // 移除旧的事件监听器
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
                
                // 添加新的事件监听器
                newItem.addEventListener('click', function(e) {
                    console.log('点击下拉菜单项:', this);
                    e.preventDefault();
                    e.stopPropagation();
                    const id = parseInt(this.getAttribute('data-id'));
                    console.log('菜单项ID:', id);
                    const action = this.classList.contains('favorite-item') ? 'favorite' : 
                                  this.classList.contains('rename-item') ? 'rename' : 'delete';
                    console.log('执行操作:', action);
                    
                    // 关闭下拉菜单
                    const dropdown = this.closest('.dropdown-menu');
                    if (dropdown) {
                        dropdown.classList.remove('show');
                    }
                    
                    // 执行相应操作
                    switch(action) {
                        case 'favorite':
                            favoriteConversation(id);
                            break;
                        case 'rename':
                            renameConversation(id);
                            break;
                        case 'delete':
                            deleteConversation(id);
                            break;
                    }
                });
            });
        }
        
        // 收藏对话
        function favoriteConversation(id) {
            const conversation = historyItems.find(item => item.id === id);
            if (!conversation) return;
            
            // 检查是否已收藏
            const existingIndex = favoriteItems.findIndex(item => item.id === id);
            if (existingIndex !== -1) {
                alert('该对话已收藏');
                return;
            }
            
            // 添加到收藏
            favoriteItems.unshift({
                id: conversation.id,
                firstQuestion: conversation.firstQuestion,
                messages: [...conversation.messages],
                createdAt: conversation.createdAt
            });
            
            // 更新收藏列表
            renderFavoritesSubmenu();
            alert('收藏成功');
        }
        
        // 重命名对话
        function renameConversation(id) {
            const conversation = historyItems.find(item => item.id === id);
            if (!conversation) return;
            
            const newName = prompt('请输入新的对话名称:', conversation.firstQuestion);
            if (newName && newName.trim()) {
                conversation.firstQuestion = newName.trim();
                renderHistorySubmenu();
                alert('重命名成功');
            }
        }
        
        // 删除对话
        function deleteConversation(id) {
            if (confirm('确定要删除此对话吗？')) {
                // 从历史对话中删除
                const historyIndex = historyItems.findIndex(item => item.id === id);
                if (historyIndex !== -1) {
                    historyItems.splice(historyIndex, 1);
                    renderHistorySubmenu();
                }
                
                // 从收藏中删除
                const favoriteIndex = favoriteItems.findIndex(item => item.id === id);
                if (favoriteIndex !== -1) {
                    favoriteItems.splice(favoriteIndex, 1);
                    renderFavoritesSubmenu();
                }
                
                alert('删除成功');
            }
        }
        
        // 初始绑定
        bindAbilityItems();
        bindPanelButtons();

        // 新对话按钮点击事件
        const newChatBtn = document.querySelector('.fa-plus').closest('button');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', function() {
                // 保存当前对话
                saveCurrentConversation();
                
                // 清除选中状态和多选模式
                selectedMessages.clear();
                isMultiSelectMode = false;
                if (typeof exitMultiSelectMode === 'function') {
                    try {
                        exitMultiSelectMode();
                    } catch (e) {
                        console.warn('退出多选模式时出错:', e);
                    }
                }
                
                // 清空当前消息、进阶推荐和提示框，但保留中部能力模块
                const toRemove = aiMessages.querySelectorAll('.message, .followups-container, .permission-help-box');
                toRemove.forEach(node => node.remove());

                // 重新查找 abilityPanels（可能已被清除）
                let currentAbilityPanels = document.querySelector('.ability-panels');
                
                // 如果 abilityPanels 不存在，需要重新创建
                if (!currentAbilityPanels || !aiMessages.contains(currentAbilityPanels)) {
                    // 重新创建 abilityPanels（使用初始HTML模板）
                    aiMessages.innerHTML = `
                        <div class="message bot-message">
                            <div class="avatar-small bot-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                您好！我是AI智能助手，展示认证流程，包括考试预约、获取与验证证书的入口，以及可能涉及的重认证规则。有什么可以帮助您的吗？
                            </div>
                        </div>
                        <div class="ability-panels">
                            <div class="ability-card">
                                <div class="ability-card-header">
                                    <span class="ability-card-title">场景领域</span>
                                </div>
                                <div class="ability-list">
                                    <button class="ability-item scene-domain-item" data-question="DCU 驱动下载">
                                        <div class="ability-item-title">DCU</div>
                                        <div class="ability-item-subtitle">获取最新 DCU 驱动与工具</div>
                                    </button>
                                    <button class="ability-item scene-domain-item" data-question="CPU 固件与驱动下载">
                                        <div class="ability-item-title">CPU</div>
                                        <div class="ability-item-subtitle">CPU 固件、驱动及文档资源</div>
                                    </button>
                                </div>
                            </div>
                            <div class="ability-card">
                                <div class="ability-card-header">
                                    <span class="ability-card-title">推广</span>
                                    <div class="ability-card-page">
                                        <span>2/3</span>
                                        <i class="fas fa-angle-right"></i>
                                    </div>
                                </div>
                                <div class="ability-list">
                                    <button class="ability-item" data-question="在线学习">
                                        <div class="ability-item-title">在线学习</div>
                                        <div class="ability-item-subtitle">学习在线课程</div>
                                    </button>
                                    <button class="ability-item" data-question="认证其他问题">
                                        <div class="ability-item-title">认证其他问题</div>
                                        <div class="ability-item-subtitle">发起问题单</div>
                                    </button>
                                    <button class="ability-item" data-question="证书申请流程">
                                        <div class="ability-item-title">证书申请流程</div>
                                        <div class="ability-item-subtitle">认证证书申请流程</div>
                                    </button>
                                </div>
                            </div>
                            <div class="ability-card">
                                <div class="ability-card-header">
                                    <span class="ability-card-title">Q&A</span>
                                </div>
                                <div class="guess-questions">
                                    <button class="guess-question" data-question="HCIE实验预约及考位查询">实验预约及考位查询</button>
                                    <button class="guess-question" data-question="认证考试证书有效期">认证考试证书有效期</button>
                                    <button class="guess-question" data-question="取消考试政策">取消考试政策</button>
                                </div>
                                <div class="guess-banner">
                                    <div class="guess-banner-content">
                                        <div class="guess-banner-title">全新焕变</div>
                                        <div class="guess-banner-subtitle">能力升级 AI 问答更懂你</div>
                                    </div>
                                    <div class="guess-banner-action">
                                        <i class="fas fa-arrow-right"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    // 重新绑定事件
                    bindAbilityItems();
                    // 重新绑定场景领域标签事件
                    const newSceneDomainItems = document.querySelectorAll('.scene-domain-item');
                    newSceneDomainItems.forEach(item => {
                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            newSceneDomainItems.forEach(i => i.classList.remove('active'));
                            this.classList.add('active');
                            const titleEl = this.querySelector('.ability-item-title');
                            currentSceneDomain = titleEl ? titleEl.textContent.trim() : this.textContent.trim();
                            if (selectedSceneDomain && selectedSceneDomainText) {
                                selectedSceneDomain.style.display = 'block';
                                selectedSceneDomainText.textContent = currentSceneDomain;
                            }
                            currentMode = 'download';
                            updateModeUI();
                        });
                    });
                } else {
                    // 如果 abilityPanels 存在，在它前面插入欢迎消息
                    const welcome = document.createElement('div');
                    welcome.className = 'message bot-message';

                    const avatar = document.createElement('div');
                    avatar.className = 'avatar-small bot-avatar';
                    avatar.innerHTML = '<i class="fas fa-robot"></i>';

                    const content = document.createElement('div');
                    content.className = 'message-content';
                    content.textContent = '您好！我是AI智能助手，展示认证流程，包括考试预约、获取与验证证书的入口，以及可能涉及的重认证规则。有什么可以帮助您的吗？';

                    welcome.appendChild(avatar);
                    welcome.appendChild(content);

                    aiMessages.insertBefore(welcome, currentAbilityPanels);
                }

                // 确保面板显示
                if (panelChat) {
                    panelChat.style.display = 'flex';
                }

                // 调用 switchPanel 确保所有状态正确
                switchPanel('chat');
                
                // 强制显示输入框（确保在 switchPanel 之后）
                if (chatInputArea) {
                    chatInputArea.style.display = 'block';
                }
                if (inputArea) {
                    inputArea.style.display = 'block';
                }
                if (actionButtonsArea) {
                    actionButtonsArea.style.display = 'none';
                }

                // 新对话：重新展开
                setPanelsCollapsed(false);
                
                // 重置当前对话ID
                currentConversationId = null;
                currentConversationMessages = [];
            });
        }

        // 右键菜单功能
        function showContextMenu(e) {
            e.preventDefault();
            if (e.target.closest('.message')) {
                currentMessage = e.target.closest('.message');
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.clientX + 'px';
                contextMenu.style.top = e.clientY + 'px';
            }
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
            currentMessage = null;
        }

        // 为所有消息添加右键菜单
        aiMessages.addEventListener('contextmenu', showContextMenu);

        // 点击其他地方隐藏右键菜单
        document.addEventListener('click', hideContextMenu);

        // 多选功能
        function enterMultiSelectMode() {
            isMultiSelectMode = true;
            const messages = aiMessages.querySelectorAll('.message');
            messages.forEach(message => {
                // 添加复选框
                let checkbox = message.querySelector('.message-checkbox');
                if (!checkbox) {
                    checkbox = document.createElement('div');
                    checkbox.className = 'message-checkbox';
                    message.appendChild(checkbox);
                }
                checkbox.classList.add('visible');

                // 添加点击事件
                checkbox.addEventListener('click', function() {
                    toggleMessageSelection(message);
                });
            });
        }

        function exitMultiSelectMode() {
            isMultiSelectMode = false;
            selectedMessages.clear();
            const messages = aiMessages.querySelectorAll('.message');
            messages.forEach(message => {
                const checkbox = message.querySelector('.message-checkbox');
                if (checkbox) {
                    checkbox.classList.remove('visible', 'checked');
                }
                message.classList.remove('selected');
            });
            updateActionButtons();
        }

        function toggleMessageSelection(message) {
            if (selectedMessages.has(message)) {
                selectedMessages.delete(message);
                message.classList.remove('selected');
                const checkbox = message.querySelector('.message-checkbox');
                if (checkbox) {
                    checkbox.classList.remove('checked');
                }
            } else {
                selectedMessages.add(message);
                message.classList.add('selected');
                const checkbox = message.querySelector('.message-checkbox');
                if (checkbox) {
                    checkbox.classList.add('checked');
                }
            }
            updateActionButtons();
        }

        function updateActionButtons() {
            if (!actionButtonsArea || !inputArea) return;
            if (selectedMessages.size > 0) {
                actionButtonsArea.classList.add('visible');
                inputArea.style.display = 'none';
            } else {
                actionButtonsArea.classList.remove('visible');
                inputArea.style.display = 'block';
            }
        }

        // 右键菜单多选选项点击事件
        if (contextMenuMultiselect) {
            contextMenuMultiselect.addEventListener('click', function() {
                enterMultiSelectMode();
                hideContextMenu();
            });
        }

        // 取消选择
        if (cancelSelection) {
            cancelSelection.addEventListener('click', function() {
                exitMultiSelectMode();
            });
        }

        // 操作按钮点击事件
        if (actionCopy) {
            actionCopy.addEventListener('click', function() {
                // 复制选中消息内容
                let text = '';
                selectedMessages.forEach(message => {
                    const content = message.querySelector('.message-content');
                    if (content) {
                        text += content.textContent + '\n\n';
                    }
                });
                navigator.clipboard.writeText(text).then(() => {
                    alert('复制成功！');
                });
            });
        }

        if (actionFavorite) {
            actionFavorite.addEventListener('click', function() {
                if (selectedMessages.size === 0) {
                    alert('请先选择要收藏的消息');
                    return;
                }
                // 从当前对话消息中提取选中的消息
                const messages = [];
                selectedMessages.forEach(messageEl => {
                    const bubble = messageEl.querySelector('.message-content');
                    if (bubble) {
                        const isUser = messageEl.classList.contains('user-message');
                        messages.push({
                            role: isUser ? 'user' : 'bot',
                            content: bubble.textContent.trim()
                        });
                    }
                });
                if (messages.length === 0) return;
                const firstQuestion = messages.find(m => m.role === 'user')?.content || '';
                if (!firstQuestion) return;
                const now = new Date();
                const id = ++conversationIdCounter;
                favoriteItems.unshift({
                    id: id,
                    firstQuestion: firstQuestion,
                    messages: messages,
                    createdAt: formatDateTime(now)
                });
                // 只保留最近 20 条收藏
                favoriteItems = favoriteItems.slice(0, 20);
                renderFavoritesSubmenu();
                alert('收藏成功！');
                exitMultiSelectMode();
            });
        }

        if (actionShare) {
            actionShare.addEventListener('click', function() {
                // 分享功能
                alert('分享功能已触发！');
            });
        }

        if (actionTicket) {
            actionTicket.addEventListener('click', function() {
                // 跳转到工单生成页面
                window.location.href = 'ticket-generation.html';
            });
        }

        // 为新添加的消息添加右键菜单
        function addMessageWithContextMenu(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `avatar-small ${isUser ? '' : 'bot-avatar'}`;
            avatarDiv.innerHTML = `<i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-content';
            messageBubble.innerHTML = text;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(messageBubble);
            aiMessages.appendChild(messageDiv);
            
            // 滚动到底部
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // 重写addMessage函数，使用新的函数
        function addMessage(text, isUser = false) {
            addMessageWithContextMenu(text, isUser);
        }
    });
    </script>
</body>
</html>