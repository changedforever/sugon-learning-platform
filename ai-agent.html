<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能体 - 曙光学习平台</title>
    <link rel="stylesheet" href="css/tailwind.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f5f7fb;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .sidebar {
            width: 260px;
            background: #f8fafd;
            border-right: 1px solid #eaecef;
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 12px 0;
            border-bottom: 1px solid #eaecef;
            margin-bottom: 16px;
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #eaecef;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sidebar-btn:hover {
            background: #f0f4ff;
            border-color: #b0c4ff;
        }
        
        .sidebar-btn.active {
            background: #e6eeff;
            border-color: #4a86ff;
            color: #1a56db;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8fafd;
        }
        
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #eaecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
        }
        
        .chat-title-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .chat-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .chat-subtitle {
            font-size: 13px;
            color: #666;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .message {
            display: flex;
            gap: 16px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
        }
        
        .avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a86ff, #667eea);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .bot-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .message-content {
            padding: 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .user-message .message-content {
            background: linear-gradient(135deg, #4a86ff, #667eea);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message .message-content {
            background: white;
            border: 1px solid #eaecef;
            border-bottom-left-radius: 4px;
        }
        
        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .quick-question {
            padding: 8px 16px;
            background: #f0f4ff;
            border: 1px solid #d0ddf7;
            border-radius: 20px;
            font-size: 13px;
            color: #4a86ff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-question:hover {
            background: #e6eeff;
            border-color: #b0c4ff;
        }
        
        .input-area {
            padding: 12px 20px 18px;
            /* border-top: 1px solid #eaecef; */
            /* background: white; */
            margin-top: 0;
        }

        /* 能力场景 + 猜你想问 卡片区域 */
        .ability-panels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 900px;          /* 略微加宽，容纳三列卡片 */
            margin: 40px auto 16px;    /* 在对话区中间偏上的位置居中 */
        }

        .ability-card {
            background: linear-gradient(135deg, #fff7f7, #fff9fb);
            border-radius: 18px;
            padding: 14px 16px 16px;
            box-shadow: 0 8px 18px rgba(255, 139, 154, 0.1);
            border: 1px solid rgba(255, 160, 180, 0.35);
        }

        .ability-card:nth-child(2) {
            background: linear-gradient(135deg, #fffaf3, #fff9f0);
            box-shadow: 0 8px 18px rgba(255, 179, 102, 0.12);
            border-color: rgba(255, 193, 120, 0.45);
        }

        .ability-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            color: #555;
        }

        .ability-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .ability-card-page {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #999;
        }

        .ability-card-page i {
            font-size: 11px;
        }

        .ability-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ability-item {
            text-align: left;
            padding: 10px 12px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .ability-item:hover {
            background: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 160, 180, 0.18);
        }

        .ability-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }

        .ability-item-subtitle {
            font-size: 12px;
            color: #999;
        }

        .guess-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .guess-question {
            padding: 6px 10px;
            border-radius: 16px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .guess-question:hover {
            background: #ffffff;
            color: #333;
            box-shadow: 0 4px 10px rgba(255, 193, 120, 0.25);
            transform: translateY(-1px);
        }

        .guess-banner {
            margin-top: 6px;
            padding: 10px 12px;
            border-radius: 12px;
            background: linear-gradient(90deg, #fef0ff, #e3f0ff);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .guess-banner-content {
            flex: 1;
        }

        .guess-banner-title {
            font-size: 13px;
            font-weight: 600;
            color: #444;
            margin-bottom: 2px;
        }

        .guess-banner-subtitle {
            font-size: 11px;
            color: #888;
        }

        .guess-banner-action {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff8a4a;
            font-size: 13px;
        }

        /* 收起动画：回答问题时隐藏能力场景/猜你想问（以及可选的快捷提问） */
        .ability-panels,
        .quick-questions {
            transition: max-height 0.25s ease, opacity 0.2s ease, margin 0.25s ease;
            overflow: hidden;
        }

        .chat-container.panels-collapsed .ability-panels,
        .chat-container.panels-collapsed .quick-questions {
            max-height: 0 !important;
            opacity: 0;
            margin-bottom: 0 !important;
            pointer-events: none;
        }
        
        .input-container {
            position: relative;
            display: flex;
            flex-direction: column;
            background: white;
            border: 1px solid #eaecef;
            border-radius: 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-container:focus-within {
            border-color: #4a86ff;
            box-shadow: 0 0 0 2px rgba(74, 134, 255, 0.1);
        }

        .input-inner-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 12px;
        }
        
        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 0;
            font-size: 15px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            background: transparent;
        }
        
        .message-input:focus {
            border: none;
            box-shadow: none;
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #4a86ff, #667eea);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 134, 255, 0.3);
        }

        .send-btn:active {
            transform: translateY(0);
        }
        
        .resource-card {
            background: #f8fafd;
            border: 1px solid #eaecef;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .resource-item:last-child {
            margin-bottom: 0;
        }
        
        .resource-img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .resource-info {
            flex: 1;
        }
        
        .resource-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .resource-desc {
            font-size: 12px;
            color: #666;
        }
        
        .resource-btn {
            padding: 6px 12px;
            background: #4a86ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .welcome-icon {
            font-size: 48px;
            color: #a0aec0;
            margin-bottom: 16px;
        }
        
        .welcome-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .welcome-subtext {
            font-size: 14px;
            color: #718096;
        }

        /* 对话结束后的进阶问题推荐区域 */
        .followups-container {
            margin: 8px 0 4px 46px; /* 与头像/气泡对齐，略微缩进 */
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 80%;
            align-items: flex-start;
        }

        .followup-btn {
            border: none;
            outline: none;
            background: #f3f4f6;
            color: #4b5563;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease;
        }

        .followup-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(15, 23, 42, 0.12);
        }

        .followup-btn span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .followup-icon {
            font-size: 12px;
            color: #9ca3af;
        }

        /* 提示框样式 - 分割线 */
        .permission-help-box {
            margin: 12px 0 8px 46px;
            max-width: 80%;
            padding: 14px 16px 14px 0;
            border-top: 1px solid #eaecef;
        }

        .permission-help-text {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            font-weight: 500;
        }

        /* 技能选择器样式（下载 + 二级标签） - 默认隐藏，根据需要再启用 */
        .skill-selector {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px 6px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border-bottom: 1px solid #f0f0f0;
        }

        .skill-selector::-webkit-scrollbar {
            display: none;
        }

        /* 一级：下载 按钮 */
        .skill-main {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 18px;
            background: #f5f5f7;
            border: 1px solid #e0e0e0;
            color: #555;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
        }

        .skill-main-label {
            padding: 0 2px;
        }

        .skill-main-close {
            font-size: 12px;
            color: #b0b0b0;
            margin-left: 2px;
            display: none; /* 默认不展示，展开后再显示 */ 
        }

        .skill-main.expanded {
            background: #f0f2ff;
            border-color: #d0d5ff;
            color: #333;
        }

        .skill-main.expanded .skill-main-close {
            color: #999;
            display: inline-block;
        }

        /* 二级：CPU / DCU / 云计算 标签 */
        .skill-sub-list {
            display: none;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
        }

        .skill-selector.expanded .skill-sub-list {
            display: inline-flex;
        }

        .skill-sub-item {
            padding: 4px 12px;
            border-radius: 14px;
            background: #f7f7f8;
            border: 1px solid transparent;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.16s ease;
        }

        .skill-sub-item:hover {
            background: #ffffff;
            border-color: #e0e0e0;
        }

        .skill-sub-item.active {
            background: #ffffff;
            border-color: #d0d5ff;
            color: #333;
            box-shadow: 0 0 0 1px rgba(115, 130, 255, 0.35);
        }

        /* 场景领域标签选中样式 */
        .scene-domain-item.active {
            background: #ffffff;
            border: 1px solid #d0d5ff;
            color: #333;
            box-shadow: 0 0 0 1px rgba(115, 130, 255, 0.35);
        }

        /* 已选领域提示为独立标签样式 */
        .selected-scene-domain {
            margin: 4px 12px 0;
            font-size: 12px;
            display: none;
        }

        .selected-scene-domain-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            border: 1px solid #c7d2fe;
        }

        .selected-scene-domain-text {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selected-scene-domain-close {
            cursor: pointer;
            font-size: 11px;
            color: #9ca3af;
            padding-left: 2px;
        }

        .selected-scene-domain-close:hover {
            color: #6b7280;
        }

        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #eaecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f0f4ff;
            color: #4a86ff;
        }

        /* 消息多选样式 */
        .message {
            position: relative;
        }

        .message-checkbox {
            position: absolute;
            top: 8px;
            left: -24px;
            width: 16px;
            height: 16px;
            border: 1px solid #eaecef;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: none;
            z-index: 10;
        }

        .message-checkbox.visible {
            display: block;
        }

        .message-checkbox.checked {
            background: #4a86ff;
            border-color: #4a86ff;
        }

        .message-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .message.selected {
            background: rgba(74, 134, 255, 0.05);
            border-radius: 12px;
            padding-left: 8px;
        }

        /* 底部操作按钮区域 */
        .action-buttons-area {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #eaecef;
            display: none;
            justify-content: space-between;
            align-items: center;
        }

        .action-buttons-area.visible {
            display: flex;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            padding: 10px 20px;
            border: 1px solid #eaecef;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: #f8fafd;
            border-color: #4a86ff;
            color: #4a86ff;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #4a86ff, #667eea);
            color: white;
            border-color: #4a86ff;
        }

        .action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 134, 255, 0.3);
        }

        .cancel-selection {
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .cancel-selection:hover {
            background: #f0f0f0;
        }

        /* 模式切換開關（問答 / 下載） */
        .mode-toggle-wrapper {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 4px;
        }

        .mode-toggle-label {
            font-size: 12px;
            color: #888;
        }

        .mode-toggle {
            position: relative;
            width: 112px;
            height: 30px;
            border-radius: 999px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 2px;
            box-sizing: border-box;
            transition: background 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.03);
        }

        .mode-toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 54px;
            height: 24px;
            border-radius: 999px;
            background: #4a86ff;
            color: #fff;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.18s ease, background 0.18s ease, box-shadow 0.18s ease;
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.35);
        }

        .mode-toggle-text {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 12px;
            color: #9ca3af;
            user-select: none;
        }

        .mode-toggle.mode-download {
            background: #ecfdf5;
            border-color: #a7f3d0;
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.25);
        }

        .mode-toggle.mode-download .mode-toggle-knob {
            transform: translateX(54px);
            background: #10b981;
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.35);
        }

        .mode-toggle.mode-qa .mode-text-qa {
            color: #111827;
            font-weight: 600;
        }

        .mode-toggle.mode-download .mode-text-download {
            color: #047857;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- 右键菜单 -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="context-menu-multiselect">多选</div>
    </div>

    <div class="chat-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i class="fas fa-robot"></i>
                    <span>AI 智能体</span>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="sidebar-btn active" data-target="chat">
                    <i class="fas fa-plus"></i>
                    <span>新对话</span>
                </button>
                <button class="sidebar-btn" data-target="favorites">
                    <i class="fas fa-star"></i>
                    <span>我的收藏</span>
                </button>
                <button class="sidebar-btn" data-target="history">
                    <i class="fas fa-history"></i>
                    <span>历史对话</span>
                </button>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 头部 -->
            <div class="chat-header">
                <div class="chat-title-area">
                    <div class="avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <div class="chat-title">AI智能助手</div>
                        <div class="chat-subtitle" id="chat-subtitle-text">问你所惑，解你所需</div>
                    </div>
                </div>
                <a href="index.html" class="close-btn">
                    <i class="fas fa-times"></i>
                </a>
            </div>

            <!-- 新对话主面板 -->
            <div id="panel-chat" class="panel-section">
                <!-- 消息区域 -->
                <div id="ai-messages" class="messages-container">
                <div class="message bot-message">
                    <div class="avatar-small bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        您好！我是AI智能助手，展示认证流程，包括考试预约、获取与验证证书的入口，以及可能涉及的重认证规则。有什么可以帮助您的吗？
                    </div>
                </div>

                <!-- 能力场景 + 猜你想问（移动到中间内容区域） -->
                <div class="ability-panels">
                    <!-- 右侧：下载相关（DCU / CPU） -->
                    <div class="ability-card">
                        <div class="ability-card-header">
                            <span class="ability-card-title">场景领域</span>
                        </div>
                        <div class="ability-list">
                            <button class="ability-item scene-domain-item" data-question="DCU 驱动下载">
                                <div class="ability-item-title">DCU</div>
                                <div class="ability-item-subtitle">获取最新 DCU 驱动与工具</div>
                            </button>
                            <button class="ability-item scene-domain-item" data-question="CPU 固件与驱动下载">
                                <div class="ability-item-title">CPU</div>
                                <div class="ability-item-subtitle">CPU 固件、驱动及文档资源</div>
                            </button>
                        </div>
                    </div>
                    <!-- 左侧：能力场景 -->
                    <div class="ability-card">
                        <div class="ability-card-header">
                            <span class="ability-card-title">推广</span>
                            <div class="ability-card-page">
                                <span>2/3</span>
                                <i class="fas fa-angle-right"></i>
                            </div>
                        </div>
                        <div class="ability-list">
                            <button class="ability-item" data-question="在线学习">
                                <div class="ability-item-title">在线学习</div>
                                <div class="ability-item-subtitle">学习在线课程</div>
                            </button>
                            <button class="ability-item" data-question="认证其他问题">
                                <div class="ability-item-title">认证其他问题</div>
                                <div class="ability-item-subtitle">发起问题单</div>
                            </button>
                            <button class="ability-item" data-question="证书申请流程">
                                <div class="ability-item-title">证书申请流程</div>
                                <div class="ability-item-subtitle">认证证书申请流程</div>
                            </button>
                        </div>
                    </div>

                    <!-- 中间：猜你想问 -->
                    <div class="ability-card">
                        <div class="ability-card-header">
                            <span class="ability-card-title">Q&A</span>
                        </div>
                        <div class="guess-questions">
                            <button class="guess-question" data-question="HCIE实验预约及考位查询">实验预约及考位查询</button>
                            <button class="guess-question" data-question="认证考试证书有效期">认证考试证书有效期</button>
                            <button class="guess-question" data-question="取消考试政策">取消考试政策</button>
                        </div>
                        <div class="guess-banner">
                            <div class="guess-banner-content">
                                <div class="guess-banner-title">全新焕变</div>
                                <div class="guess-banner-subtitle">能力升级 AI 问答更懂你</div>
                            </div>
                            <div class="guess-banner-action">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 输入区域 -->
            <div class="input-area" id="chat-input-area">
                <!-- 原有快捷提问，仍然保留 -->
                <div class="quick-questions" id="ai-quick-questions">
                    <button class="quick-question">如何参加考试？</button>
                    <button class="quick-question">如何认证成为高级云架构师？</button>
                    <button class="quick-question">如何查看和下载证书</button>
                </div>
                <div class="input-container" style="position: relative;">
                    <!-- 模式切换：问答 / 下载 -->
                    <div class="mode-toggle-wrapper">
                        <div id="mode-toggle" class="mode-toggle mode-qa">
                            <div class="mode-toggle-knob" id="mode-toggle-knob">问答</div>
                            <div class="mode-toggle-text">
                                <span class="mode-text-qa">问答</span>
                                <span class="mode-text-download">下载</span>
                            </div>
                        </div>
                    </div>
                    <!-- 场景领域提示标签（独立标签） -->
                    <div id="selected-scene-domain" class="selected-scene-domain">
                        <span class="selected-scene-domain-tag">
                            <span class="selected-scene-domain-text" id="selected-scene-domain-text"></span>
                            <span class="selected-scene-domain-close" id="selected-scene-domain-close">×</span>
                        </span>
                    </div>
                    <!-- 技能选择器 - 放在文本框内部上方 -->
                    <div class="skill-selector" id="skill-selector">
                        <div class="skill-main" id="download-main">
                            <span class="skill-main-label">下载</span>
                            <span class="skill-main-close" id="download-close">×</span>
                        </div>
                        <div class="skill-sub-list" id="download-sub-list">
                            <button class="skill-sub-item">CPU</button>
                            <button class="skill-sub-item">DCU</button>
                            <button class="skill-sub-item">云计算</button>
                        </div>
                    </div>
                    <!-- 输入框和发送按钮区域 -->
                    <div class="input-inner-wrapper">
                        <textarea 
                            id="ai-input" 
                            placeholder="输入您的问题..." 
                            class="message-input"
                            rows="1"
                        ></textarea>
                        <button id="ai-send" class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- 正式联想框样式 - 市面上常见的搜索联想 -->
                    <div id="suggestion-list" style="position: absolute; bottom: 100%; left: 0; right: 0; margin-bottom: 8px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 9999; display: none; overflow: hidden; width: 100%; border: 1px solid #eaecef;">
                        <div style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s;"><span style="color: red;">智能</span>天线</div>
                        <div style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s;">全网<span style="color: red;">智能</span></div>
                        <div style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; transition: all 0.2s;">体系智<span style="color: red;">能</span>特性</div>
                    </div>
                </div>
            </div>

            <!-- 底部操作按钮区域 -->
            <div class="action-buttons-area" id="action-buttons-area">
                <div class="action-buttons">
                    <button class="action-btn" id="action-copy">
                        <i class="fas fa-copy"></i>
                        <span>复制</span>
                    </button>
                    <button class="action-btn" id="action-favorite">
                        <i class="fas fa-star"></i>
                        <span>收藏</span>
                    </button>
                    <button class="action-btn" id="action-share">
                        <i class="fas fa-share-alt"></i>
                        <span>分享</span>
                    </button>
                    <button class="action-btn primary" id="action-ticket">
                        <i class="fas fa-ticket-alt"></i>
                        <span>生成工单</span>
                    </button>
                </div>
                <button class="cancel-selection" id="cancel-selection">
                    取消
                </button>
            </div>

            <!-- 我的收藏 面板（由 JS 动态填充） -->
            <div id="panel-favorites" class="panel-section" style="display: none; padding: 24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                    <div style="font-size: 16px; font-weight: 500;">我的收藏</div>
                    <div id="favorites-count" style="font-size: 12px; color: #9ca3af;">共 0 条收藏</div>
                </div>
                <div id="favorites-empty" style="font-size: 14px; color: #9ca3af;">还没有收藏内容，可以在对话中勾选消息后点击底部「收藏」按钮。</div>
                <div id="favorites-list" style="display:none; display:flex; flex-direction:column; gap:12px;"></div>
            </div>

            <!-- 历史对话 面板（由 JS 动态填充） -->
            <div id="panel-history" class="panel-section" style="display: none; padding: 24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                    <div style="font-size: 16px; font-weight: 500;">历史对话</div>
                    <div id="history-count" style="font-size: 12px; color: #9ca3af;">最近 0 条会话</div>
                </div>
                <div id="history-empty" style="font-size: 14px; color: #9ca3af;">还没有历史对话，发起几轮问答后再来看看。</div>
                <div id="history-list" style="display:none; display:flex; flex-direction:column; gap:10px; font-size:13px;"></div>
            </div>
        </div>
    </div>


        </div>
    </div>

    <script>
        // AI智能体功能
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM加载完成，开始初始化AI智能体功能');
        
        const aiInput = document.getElementById('ai-input');
        const aiSend = document.getElementById('ai-send');
        const aiMessages = document.getElementById('ai-messages');
        const inputArea = document.querySelector('.input-area');
        const chatContainer = document.querySelector('.chat-container');
        const abilityPanels = document.querySelector('.ability-panels');
        const suggestionList = document.getElementById('suggestion-list');

        // 收藏 & 历史对话 DOM
        const favoritesList = document.getElementById('favorites-list');
        const favoritesEmpty = document.getElementById('favorites-empty');
        const favoritesCount = document.getElementById('favorites-count');
        const historyList = document.getElementById('history-list');
        const historyEmpty = document.getElementById('history-empty');
        const historyCount = document.getElementById('history-count');

        // ===== 输入联想（搜索建议）=====
        // 说明：页面原本只有 #suggestion-list 的静态结构且 display:none，但没有任何 JS 去控制它显示/渲染
        // 这里补齐“输入时联想框出现”的逻辑（本地模拟数据，后续可替换为接口）
        const SUGGESTIONS = [
            // 考试
            '如何参加考试？',
            '如何报名考试？',
            '考试入口在哪里？',
            '在线考试怎么开始？',
            '考试可以重考吗？',
            '考试成绩在哪里查看？',
            '考试通过标准是多少？',
            '考试时遇到卡顿/黑屏怎么办？',
            '考试提交后还能修改吗？',
            '线下考试怎么预约？',
            '考试注意事项有哪些？',
            '考试题型有哪些？',
            '考试时间不合适可以改期吗？',
            '考试证书多久发放？',

            // 认证
            '如何认证成为高级云架构师？',
            '认证流程是什么？',
            '认证报名条件有哪些？',
            '认证考试费用是多少？',
            '认证有效期多久？如何续证？',
            '认证证书如何下载？',
            '认证进度在哪里查看？',

            // 课程
            '如何报名课程？',
            '课程学习进度如何查看？',
            '课程学习期限是多久？',
            '课程可以重复学习吗？',
            '课程资料在哪里下载？',
            '课程评价怎么写？',
            '课程无法播放怎么办？',
            '课程视频清晰度如何调整？',
            '课程学习记录如何同步？',

            // 直播
            '直播如何预约？',
            '如何进入直播间？',
            '直播开始前会提醒吗？',
            '直播回放在哪里看？',
            '直播资料在哪里下载？',
            '直播弹幕/互动怎么用？',
            '直播卡顿怎么办？',
            '直播错过了还能回看吗？',
            '如何取消直播预约？',

            // 证书
            '如何查看和下载证书',
            '证书如何验证真伪？',
            '证书信息有误如何更正？',
            '证书丢失了怎么办？',

            // 账号与权限
            '忘记密码怎么办？',
            '如何修改手机号/邮箱？',
            '如何绑定/解绑企业信息？',
            '无法登录怎么办？',
            '账号被锁定怎么办？',

            // 下载/驱动/工具
            '如何下载 CPU / DCU ',
            '下载链接失效怎么办？',
            '安装驱动时报错如何解决？',
            '镜像/工具包在哪里下载？',
            '如何获取产品手册/白皮书？',

            // 技术支持
            '如何联系技术支持？',
            '如何提交工单？',
            '工单进度如何查看？',
            '如何反馈问题/建议？'
        ];

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function highlight(text, query) {
            if (!query) return escapeHtml(text);
            const safeText = escapeHtml(text);
            const safeQuery = escapeHtml(query);
            // 简单高亮：大小写不敏感
            const reg = new RegExp(safeQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'ig');
            return safeText.replace(reg, (m) => `<span style="color: #B01F24;">${m}</span>`);
        }

        function hideSuggestions() {
            if (!suggestionList) return;
            suggestionList.style.display = 'none';
            suggestionList.innerHTML = '';
        }

        function showSuggestions(items, query) {
            if (!suggestionList) return;
            if (!items.length) {
                hideSuggestions();
                return;
            }

            suggestionList.innerHTML = items.map((t, idx) => {
                const border = idx === items.length - 1 ? '' : 'border-bottom: 1px solid #f0f0f0;';
                return `
                    <div class="suggestion-item"
                         data-text="${escapeHtml(t)}"
                         style="padding: 12px 16px; font-size: 14px; color: #333; cursor: pointer; ${border} transition: all 0.2s;">
                        ${highlight(t, query)}
                    </div>
                `;
            }).join('');

            suggestionList.style.display = 'block';

            // hover 样式（内联结构下用 JS 绑定更稳）
            suggestionList.querySelectorAll('.suggestion-item').forEach(el => {
                el.addEventListener('mouseenter', () => {
                    el.style.background = '#f8fafc';
                });
                el.addEventListener('mouseleave', () => {
                    el.style.background = 'transparent';
                });
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const text = el.getAttribute('data-text') || '';
                    if (aiInput) {
                        aiInput.value = text;
                        aiInput.focus();
                        // 触发一次 input 以便高度自适应更新
                        aiInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    hideSuggestions();
                });
            });
        }

        function updateSuggestions() {
            if (!aiInput || !suggestionList) return;
            const q = aiInput.value.trim();
            const qLower = q.toLowerCase();

            // 规则：不管输入啥都给联想
            // - 有输入：优先显示匹配项；若匹配不足，用热门推荐补齐；并加入“按你的输入提问”兜底项
            // - 无输入：不显示（避免未输入就弹窗）
            const HOT = SUGGESTIONS.slice(0, 12);

            if (!q) {
                hideSuggestions();
                return;
            }

            let matched = [];
            if (q) {
                matched = SUGGESTIONS.filter(t => t.toLowerCase().includes(qLower));
            }

            let results = [];

            if (q) {
                // 兜底：把用户输入本身作为第一条
                results.push(`按“${q}”提问`);

                // 匹配项（去重）
                matched.slice(0, 8).forEach(t => {
                    if (!results.includes(t)) results.push(t);
                });

                // 热门补齐
                HOT.forEach(t => {
                    if (results.length >= 10) return;
                    if (!results.includes(t)) results.push(t);
                });
                showSuggestions(results, q);
            }
        }
        
        // 右键菜单和多选功能
        const contextMenu = document.getElementById('context-menu');
        const contextMenuMultiselect = document.getElementById('context-menu-multiselect');
        const actionButtonsArea = document.getElementById('action-buttons-area');
        const cancelSelection = document.getElementById('cancel-selection');
        const actionCopy = document.getElementById('action-copy');
        const actionFavorite = document.getElementById('action-favorite');
        const actionShare = document.getElementById('action-share');
        const actionTicket = document.getElementById('action-ticket');
        
        let isMultiSelectMode = false;
        let selectedMessages = new Set();
        let currentMessage = null;

        // 我的收藏 & 历史对话数据
        let favoriteItems = []; // {content, createdAt}
        let historyItems = [];  // {question, createdAt}
        
        // 当前选中的技能与模式
        let currentSkill = '通用';
        let currentMode = 'qa'; // qa 問答模式；download 下載模式

        // 模式切換 DOM
        const modeToggle = document.getElementById('mode-toggle');
        const modeToggleKnob = document.getElementById('mode-toggle-knob');

        function updateModeUI() {
            if (!modeToggle || !modeToggleKnob || !aiInput) return;
            if (currentMode === 'qa') {
                modeToggle.classList.remove('mode-download');
                modeToggle.classList.add('mode-qa');
                modeToggleKnob.textContent = '問答';
                aiInput.placeholder = '输入您的问题...';
            } else {
                modeToggle.classList.remove('mode-qa');
                modeToggle.classList.add('mode-download');
                modeToggleKnob.textContent = '下載';
                aiInput.placeholder = '请输入需要下载的内容，如“CPU 驱动下载地址”...';
            }
        }

        if (modeToggle) {
            modeToggle.addEventListener('click', function () {
                currentMode = currentMode === 'qa' ? 'download' : 'qa';
                updateModeUI();
            });
            // 初始化一次 UI
            updateModeUI();
        }

        // 下载技能：展开 / 收起二级标签
        const skillSelector = document.getElementById('skill-selector');
        const downloadMain = document.getElementById('download-main');
        const downloadClose = document.getElementById('download-close');

        function toggleDownload(expanded) {
            if (!skillSelector || !downloadMain) return;
            if (expanded) {
                skillSelector.classList.add('expanded');
                downloadMain.classList.add('expanded');
            } else {
                skillSelector.classList.remove('expanded');
                downloadMain.classList.remove('expanded');
            }
        }

        if (downloadMain) {
            downloadMain.addEventListener('click', function(e) {
                // 如果点击的是关闭 X，则直接收起
                if (e.target === downloadClose) {
                    toggleDownload(false);
                    e.stopPropagation();
                    return;
                }
                const isExpanded = downloadMain.classList.contains('expanded');
                toggleDownload(!isExpanded);
            });
        }

        if (downloadClose) {
            downloadClose.addEventListener('click', function(e) {
                toggleDownload(false);
                e.stopPropagation();
            });
        }

        // 二级标签选中样式（CPU / DCU / 云计算）
        const subItems = document.querySelectorAll('.skill-sub-item');
        let currentDownloadTag = '';

        subItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                // 展开状态下点击标签：只高亮当前，取消其他
                subItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentDownloadTag = this.textContent.trim();
            });
        });

        function setPanelsCollapsed(collapsed) {
            if (!chatContainer) return;
            chatContainer.classList.toggle('panels-collapsed', !!collapsed);
        }
        
        // 自动调整文本框高度 + 输入联想
        aiInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight > 120 ? 120 : this.scrollHeight) + 'px';
            updateSuggestions();
        });

        // 聚焦时也尝试展示（如果已有内容）
        aiInput.addEventListener('focus', () => {
            updateSuggestions();
        });

        // 点击外部收起联想
        document.addEventListener('click', (e) => {
            if (!suggestionList) return;
            const target = e.target;
            const clickedInsideSuggestion = suggestionList.contains(target);
            const clickedInsideInput = aiInput && (aiInput === target || aiInput.contains(target));
            if (!clickedInsideSuggestion && !clickedInsideInput) {
                hideSuggestions();
            }
        });
        
        // 添加消息到对话框
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `avatar-small ${isUser ? '' : 'bot-avatar'}`;
            avatarDiv.innerHTML = `<i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-content';
            messageBubble.innerHTML = text;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(messageBubble);
            aiMessages.appendChild(messageDiv);
            
            // 滚动到底部
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // 处理AI回复
        function handleAIResponse(userMessage, skill = '通用') {
            // 模拟AI思考时间
            setTimeout(() => {
                const responses = {
                  '如何参加考试？': `
                    <div class="space-y-3">
                      <p>参加考试的具体流程如下：</p>
                      <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>登录平台，进入"我的考试"页面</li>
                        <li>选择需要参加的考试科目</li>
                        <li>确认考试时间和要求</li>
                        <li>完成在线考试或预约线下考试</li>
                        <li>提交答卷后等待成绩公布</li>
                      </ul>
                      <div class="resource-card">
                        <div class="resource-item">
                          <img src="https://images.unsplash.com/photo-1581093458791-8a0a5d5c5f5a?auto=format&fit=crop&w=100&q=80" 
                               class="resource-img" 
                               alt="考试流程">
                          <div class="resource-info">
                            <div class="resource-title">考试流程详解视频</div>
                            <div class="resource-desc">详细讲解考试报名和参加流程</div>
                          </div>
                          <button class="resource-btn">
                            <i class="fas fa-play"></i> 播放
                          </button>
                        </div>
                      </div>
                    </div>
                  `,
                  '如何认证成为高级云架构师？': `
                    <div class="space-y-3">
                      <p>成为高级云架构师的认证路径：</p>
                      <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>具备相关工作经验（3年以上云计算经验）</li>
                        <li>完成高级云架构师培训课程</li>
                        <li>通过理论考试和实操考核</li>
                        <li>提交项目案例和设计方案</li>
                        <li>通过专家评审委员会的审核</li>
                      </ul>
                      <div class="resource-card">
                        <div class="resource-item">
                          <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&w=100&q=80" 
                               class="resource-img" 
                               alt="云架构师认证">
                          <div class="resource-info">
                            <div class="resource-title">高级云架构师认证指南</div>
                            <div class="resource-desc">完整认证流程和备考策略</div>
                          </div>
                          <button class="resource-btn">
                            <i class="fas fa-play"></i> 播放
                          </button>
                        </div>
                      </div>
                    </div>
                  `,
                  '如何查看和下载证书': `
                    <div class="space-y-3">
                      <p>查看和下载证书的操作步骤：</p>
                      <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>登录个人中心，进入"我的证书"页面</li>
                        <li>查看已获得的证书列表</li>
                        <li>点击证书查看详细信息</li>
                        <li>选择下载格式（PDF/图片）</li>
                        <li>验证证书真伪（可选）</li>
                      </ul>
                      <div class="resource-card">
                        <div class="resource-item">
                          <img src="https://images.unsplash.com/photo-1561070791-2526d30994b5?auto=format&fit=crop&w=100&q=80" 
                               class="resource-img" 
                               alt="证书管理">
                          <div class="resource-info">
                            <div class="resource-title">证书管理操作教程</div>
                            <div class="resource-desc">详细演示证书查看和下载流程</div>
                          </div>
                          <button class="resource-btn">
                            <i class="fas fa-play"></i> 播放
                          </button>
                        </div>
                      </div>
                    </div>
                  `,
                  '在线学习': '您可以通过平台的「课程学习」或「培训中心」模块，选择适合您的在线课程进行自主学习。支持视频课程、实验课程和配套资料下载。',
                  '认证其他问题': '如果您在认证过程中遇到其他问题，可以在「帮助与支持」或「工单中心」中发起问题单，我们会有专人进行跟进并答复。',
                  '证书申请流程': '通过考试后，系统会自动生成您的认证信息。您需要完善个人资料并提交证书申请，审核通过后即可在线查看与下载电子证书。',
                  'HCIE实验预约及考位查询': 'HCIE 实验考试需要提前在考试中心进行预约，您可以在「我的考试」中查看可预约考位与时间，并完成缴费后确认。',
                  '认证考试证书有效期': '大部分认证证书有效期为 3 年，具体以认证项目规则为准。您可以在「我的证书」中查看每张证书的有效期与到期提醒。',
                  '取消考试政策': '对于已预约的考试，如需取消或改期，请在考试规定时间前在「我的考试」中操作，逾期将可能无法退款或需要支付改期费用。',

                  // 进阶提问固定回答
                  '考试报名入口在哪里？': '您可以在平台顶部导航进入「考试中心」或「我的考试」，在「可报名考试」列表中点击对应考试右侧的“立即报名”按钮完成报名。',
                  '考试报名有哪些条件限制？': '不同考试的报名条件不同，一般包括：已完成指定先修课程、满足工作年限要求以及通过前置级别考试等，具体可在考试详情页查看。',
                  '如何查看考试成绩与证书获取情况？': '考试结束后，您可以在「我的考试」中查看成绩，在「我的证书」模块查看是否已生成对应证书及其状态。',

                  '高级云架构师培训课有哪些学习路径？': '通常包括基础云计算课程、高级架构设计课程以及实践项目课程，建议按“基础理论→核心技能→场景实践”的路径进行学习。',
                  '高级云架构师考试都考哪些内容？': '考试一般覆盖云基础架构设计、网络与安全、性能与高可用、成本优化以及典型行业场景设计等内容，具体以考试大纲为准。',

                  '证书到期前需要做哪些准备？': '建议提前 3-6 个月关注证书到期时间，了解重认证规则，规划好补修课程或重认证考试，避免证书失效影响个人资质。'
                };

                // 每个主问题对应的进阶推荐问题列表
                const followupsMap = {
                  '如何参加考试？': [
                    '考试报名入口在哪里？',
                    '考试报名有哪些条件限制？',
                    '如何查看考试成绩与证书获取情况？'
                  ],
                  '如何认证成为高级云架构师？': [
                    '高级云架构师培训课有哪些学习路径？',
                    '高级云架构师考试都考哪些内容？'
                  ],
                  '如何查看和下载证书': [
                    '证书到期前需要做哪些准备？',
                    '认证考试证书有效期'
                  ]
                };
                
                const response = responses[userMessage] || '感谢您的提问！我会尽力为您提供帮助。如果您有更具体的问题，请详细描述，我会给出更精准的回答。';
                addMessage(response, false);

                // 在回答后添加红框提示框
                const helpBox = document.createElement('div');
                helpBox.className = 'permission-help-box';
                helpBox.innerHTML = '<div class="permission-help-text">我可以把这些内容整理成简洁的表格版，方便你快速查阅，需要吗？</div>';
                aiMessages.appendChild(helpBox);
                aiMessages.scrollTop = aiMessages.scrollHeight;

                // 在回答下方追加进阶问题推荐
                const followups = followupsMap[userMessage];
                if (followups && followups.length) {
                    const container = document.createElement('div');
                    container.className = 'followups-container';
                    
                    followups.forEach(text => {
                        const btn = document.createElement('button');
                        btn.className = 'followup-btn';
                        btn.innerHTML = `<span>${text}</span><i class="fas fa-arrow-right followup-icon"></i>`;
                        btn.addEventListener('click', () => {
                            addMessage(text, true);
                            addHistoryItem(text);
                            handleAIResponse(text, currentSkill);
                        });
                        container.appendChild(btn);
                    });

                    aiMessages.appendChild(container);
                    aiMessages.scrollTop = aiMessages.scrollHeight;
                }

                // 回答后收起上方卡片区域，给对话腾出空间
                setPanelsCollapsed(true);
            }, 1000);
        }

        // 发送按钮点击事件
        if (aiSend) {
            aiSend.addEventListener('click', function() {
                const message = aiInput.value.trim();
                if (message) {
                    // 在消息前添加技能标签（可选，用于显示）
                    const messageWithSkill = currentSkill !== '通用' ? `[${currentSkill}] ${message}` : message;
                    addMessage(messageWithSkill, true);
                    addHistoryItem(message);
                    // 发送后先收起（等回复出现时也会再次确保收起）
                    setPanelsCollapsed(true);
                    aiInput.value = '';
                    aiInput.style.height = 'auto';
                    handleAIResponse(message, currentSkill);
                }
            });
        }

        // 输入框回车发送
        if (aiInput) {
            aiInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    aiSend.click();
                }
            });
        }
        
        // 点击输入框时，不再自动展示下载技能选择器（按需手动扩展）

        // 预设标签点击事件（底部快捷问题）
        const presetButtons = document.querySelectorAll('#ai-quick-questions button');
        presetButtons.forEach(button => {
            button.addEventListener('click', function() {
                const message = this.textContent.trim();
                addMessage(message, true);
                addHistoryItem(message);
                setPanelsCollapsed(true);
                handleAIResponse(message, currentSkill);
            });
        });

        function formatDateTime(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${hh}:${mm}`;
        }

        function renderFavorites() {
            if (!favoritesList || !favoritesEmpty || !favoritesCount) return;
            const count = favoriteItems.length;
            favoritesCount.textContent = `共 ${count} 条收藏`;
            if (count === 0) {
                favoritesEmpty.style.display = 'block';
                favoritesList.style.display = 'none';
                favoritesList.innerHTML = '';
                return;
            }
            favoritesEmpty.style.display = 'none';
            favoritesList.style.display = 'flex';
            favoritesList.innerHTML = favoriteItems.map(item => `
                <div style="padding:12px 14px; border-radius:10px; background:#f9fafb; border:1px solid #e5e7eb; cursor:pointer;">
                    <div style="font-size:13px; color:#111827; margin-bottom:4px; white-space:pre-line;">${escapeHtml(item.content)}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; color:#9ca3af; margin-top:4px;">
                        <span>收藏于 ${item.createdAt}</span>
                        <span><i class="fas fa-star" style="color:#f59e0b; margin-right:4px;"></i>对话收藏</span>
                    </div>
                </div>
            `).join('');
        }

        function renderHistory() {
            if (!historyList || !historyEmpty || !historyCount) return;
            const count = historyItems.length;
            historyCount.textContent = `最近 ${count} 条会话`;
            if (count === 0) {
                historyEmpty.style.display = 'block';
                historyList.style.display = 'none';
                historyList.innerHTML = '';
                return;
            }
            historyEmpty.style.display = 'none';
            historyList.style.display = 'flex';
            historyList.innerHTML = historyItems.map(item => `
                <div style="padding:10px 12px; border-radius:8px; border:1px solid #e5e7eb; background:#ffffff; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                    <div style="max-width:80%; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(item.question)}</div>
                    <div style="font-size:11px; color:#9ca3af;">${item.createdAt}</div>
                </div>
            `).join('');
        }

        function addHistoryItem(question) {
            if (!question) return;
            const now = new Date();
            historyItems.unshift({
                question,
                createdAt: formatDateTime(now)
            });
            // 只保留最近 20 条
            historyItems = historyItems.slice(0, 20);
            renderHistory();
        }

        // 侧边栏：新对话 / 我的收藏 / 历史对话 切换
        const sidebarButtons = document.querySelectorAll('.sidebar-btn');
        const panelChat = document.getElementById('panel-chat');
        const panelFavorites = document.getElementById('panel-favorites');
        const panelHistory = document.getElementById('panel-history');
        const chatInputArea = document.getElementById('chat-input-area');
        const chatSubtitleText = document.getElementById('chat-subtitle-text');

        function switchPanel(target) {
            // 按钮高亮
            sidebarButtons.forEach(btn => {
                if (btn.getAttribute('data-target') === target) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // 面板显示/隐藏
            if (panelChat) panelChat.style.display = (target === 'chat') ? 'block' : 'none';
            if (chatInputArea) chatInputArea.style.display = (target === 'chat') ? 'block' : 'none';
            if (actionButtonsArea) actionButtonsArea.style.display = (target === 'chat' && selectedMessages.size > 0) ? 'flex' : (target === 'chat' ? 'none' : 'none');

            if (panelFavorites) panelFavorites.style.display = (target === 'favorites') ? 'block' : 'none';
            if (panelHistory) panelHistory.style.display = (target === 'history') ? 'block' : 'none';

            // 头部副标题文案
            if (chatSubtitleText) {
                if (target === 'chat') {
                    chatSubtitleText.textContent = '问你所惑，解你所需';
                } else if (target === 'favorites') {
                    chatSubtitleText.textContent = '查看你收藏的高价值问答';
                } else if (target === 'history') {
                    chatSubtitleText.textContent = '回顾你与 AI 的历史对话';
                }
            }
        }

        if (sidebarButtons.length) {
            sidebarButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const target = this.getAttribute('data-target') || 'chat';
                    switchPanel(target);
                });
            });
        }

        // 默认展示新对话面板
        switchPanel('chat');

        // 场景领域标签（仅高亮，不触发会话）
        const sceneDomainItems = document.querySelectorAll('.scene-domain-item');
        const selectedSceneDomain = document.getElementById('selected-scene-domain');
        const selectedSceneDomainText = document.getElementById('selected-scene-domain-text');
        const selectedSceneDomainClose = document.getElementById('selected-scene-domain-close');
        let currentSceneDomain = '';
        sceneDomainItems.forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                // 只作为标签选中展示
                sceneDomainItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                // 标签只保留 DCU / CPU 文本，不带描述
                const titleEl = this.querySelector('.ability-item-title');
                currentSceneDomain = titleEl ? titleEl.textContent.trim() : this.textContent.trim();

                // 在输入框上方显示当前选中领域
                if (selectedSceneDomain && selectedSceneDomainText) {
                    selectedSceneDomain.style.display = 'block';
                    selectedSceneDomainText.textContent = currentSceneDomain;
                }

                // 切换到下载模式，但不发送消息
                currentMode = 'download';
                updateModeUI();
            });
        });

        // 关闭已选领域标签
        if (selectedSceneDomainClose) {
            selectedSceneDomainClose.addEventListener('click', function () {
                // 清空当前选中状态
                currentSceneDomain = '';
                if (selectedSceneDomain) {
                    selectedSceneDomain.style.display = 'none';
                }
                if (selectedSceneDomainText) {
                    selectedSceneDomainText.textContent = '';
                }
                sceneDomainItems.forEach(i => i.classList.remove('active'));
                // 可选：关闭后仍保持下载模式，不切回问答
            });
        }

        // 能力场景 & 猜你想问卡片点击事件（不包含场景领域标签）
        const panelButtons = document.querySelectorAll('.ability-item:not(.scene-domain-item), .guess-question');
        panelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const message = this.getAttribute('data-question') || this.textContent.trim();
                addMessage(message, true);
                addHistoryItem(message);
                setPanelsCollapsed(true);
                handleAIResponse(message, currentSkill);
            });
        });

        // 新对话按钮点击事件
        const newChatBtn = document.querySelector('.fa-plus').closest('button');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', function() {
                // 清空当前消息、进阶推荐和提示框，但保留中部能力模块
                const toRemove = aiMessages.querySelectorAll('.message, .followups-container, .permission-help-box');
                toRemove.forEach(node => node.remove());

                // 重新插入欢迎消息到能力模块上方
                if (abilityPanels) {
                    const welcome = document.createElement('div');
                    welcome.className = 'message bot-message';

                    const avatar = document.createElement('div');
                    avatar.className = 'avatar-small bot-avatar';
                    avatar.innerHTML = '<i class="fas fa-robot"></i>';

                    const content = document.createElement('div');
                    content.className = 'message-content';
                    content.textContent = '您好！我是AI智能助手，展示认证流程，包括考试预约、获取与验证证书的入口，以及可能涉及的重认证规则。有什么可以帮助您的吗？';

                    welcome.appendChild(avatar);
                    welcome.appendChild(content);

                    aiMessages.insertBefore(welcome, abilityPanels);
                }

                // 新对话：重新展开
                setPanelsCollapsed(false);
            });
        }

        // 右键菜单功能
        function showContextMenu(e) {
            e.preventDefault();
            if (e.target.closest('.message')) {
                currentMessage = e.target.closest('.message');
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.clientX + 'px';
                contextMenu.style.top = e.clientY + 'px';
            }
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
            currentMessage = null;
        }

        // 为所有消息添加右键菜单
        aiMessages.addEventListener('contextmenu', showContextMenu);

        // 点击其他地方隐藏右键菜单
        document.addEventListener('click', hideContextMenu);

        // 多选功能
        function enterMultiSelectMode() {
            isMultiSelectMode = true;
            const messages = aiMessages.querySelectorAll('.message');
            messages.forEach(message => {
                // 添加复选框
                let checkbox = message.querySelector('.message-checkbox');
                if (!checkbox) {
                    checkbox = document.createElement('div');
                    checkbox.className = 'message-checkbox';
                    message.appendChild(checkbox);
                }
                checkbox.classList.add('visible');

                // 添加点击事件
                checkbox.addEventListener('click', function() {
                    toggleMessageSelection(message);
                });
            });
        }

        function exitMultiSelectMode() {
            isMultiSelectMode = false;
            selectedMessages.clear();
            const messages = aiMessages.querySelectorAll('.message');
            messages.forEach(message => {
                const checkbox = message.querySelector('.message-checkbox');
                if (checkbox) {
                    checkbox.classList.remove('visible', 'checked');
                }
                message.classList.remove('selected');
            });
            updateActionButtons();
        }

        function toggleMessageSelection(message) {
            if (selectedMessages.has(message)) {
                selectedMessages.delete(message);
                message.classList.remove('selected');
                const checkbox = message.querySelector('.message-checkbox');
                if (checkbox) {
                    checkbox.classList.remove('checked');
                }
            } else {
                selectedMessages.add(message);
                message.classList.add('selected');
                const checkbox = message.querySelector('.message-checkbox');
                if (checkbox) {
                    checkbox.classList.add('checked');
                }
            }
            updateActionButtons();
        }

        function updateActionButtons() {
            if (selectedMessages.size > 0) {
                actionButtonsArea.classList.add('visible');
                inputArea.style.display = 'none';
            } else {
                actionButtonsArea.classList.remove('visible');
                inputArea.style.display = 'block';
            }
        }

        // 右键菜单多选选项点击事件
        if (contextMenuMultiselect) {
            contextMenuMultiselect.addEventListener('click', function() {
                enterMultiSelectMode();
                hideContextMenu();
            });
        }

        // 取消选择
        if (cancelSelection) {
            cancelSelection.addEventListener('click', function() {
                exitMultiSelectMode();
            });
        }

        // 操作按钮点击事件
        if (actionCopy) {
            actionCopy.addEventListener('click', function() {
                // 复制选中消息内容
                let text = '';
                selectedMessages.forEach(message => {
                    const content = message.querySelector('.message-content');
                    if (content) {
                        text += content.textContent + '\n\n';
                    }
                });
                navigator.clipboard.writeText(text).then(() => {
                    alert('复制成功！');
                });
            });
        }

        if (actionFavorite) {
            actionFavorite.addEventListener('click', function() {
                if (selectedMessages.size === 0) {
                    alert('请先选择要收藏的消息');
                    return;
                }
                let content = '';
                selectedMessages.forEach(message => {
                    const bubble = message.querySelector('.message-content');
                    if (bubble) {
                        content += bubble.textContent.trim() + '\n';
                    }
                });
                content = content.trim();
                if (!content) return;
                const now = new Date();
                favoriteItems.unshift({
                    content,
                    createdAt: formatDateTime(now)
                });
                // 只保留最近 20 条收藏
                favoriteItems = favoriteItems.slice(0, 20);
                renderFavorites();
                alert('收藏成功！');
            });
        }

        if (actionShare) {
            actionShare.addEventListener('click', function() {
                // 分享功能
                alert('分享功能已触发！');
            });
        }

        if (actionTicket) {
            actionTicket.addEventListener('click', function() {
                // 跳转到工单生成页面
                window.location.href = 'ticket-generation.html';
            });
        }

        // 为新添加的消息添加右键菜单
        function addMessageWithContextMenu(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `avatar-small ${isUser ? '' : 'bot-avatar'}`;
            avatarDiv.innerHTML = `<i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-content';
            messageBubble.innerHTML = text;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(messageBubble);
            aiMessages.appendChild(messageDiv);
            
            // 滚动到底部
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // 重写addMessage函数，使用新的函数
        function addMessage(text, isUser = false) {
            addMessageWithContextMenu(text, isUser);
        }
    });
    </script>
</body>
</html>